<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>SysY to LLVM简易编译器文档 | 58Q83</title><meta name="author" content="58Q83,Ichigo_015@163.com"><meta name="copyright" content="58Q83"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1.编译器简介 (1) 简介  该编译器通过Java语言，实现了词法分析，语法分析，符号表管理与错误处理，llvm代码生成功能，将输入的简化的符合SysY语法的代码转换为LLVM语言。 具体语法见文法定义及相关说明  (2) 错误处理  本编译器共可处理10种错误具体如下:     错误类型 错误代码 解释     非法符号 a 格式字符串中出现非法字符，如&amp;等，报错行号为 所在行数"><meta property="og:type" content="article"><meta property="og:title" content="SysY to LLVM简易编译器文档"><meta property="og:url" content="http://example.com/post/38d18c3f.html"><meta property="og:site_name" content="58Q83"><meta property="og:description" content="1.编译器简介 (1) 简介  该编译器通过Java语言，实现了词法分析，语法分析，符号表管理与错误处理，llvm代码生成功能，将输入的简化的符合SysY语法的代码转换为LLVM语言。 具体语法见文法定义及相关说明  (2) 错误处理  本编译器共可处理10种错误具体如下:     错误类型 错误代码 解释     非法符号 a 格式字符串中出现非法字符，如&amp;等，报错行号为 所在行数"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/Ada.jpg"><meta property="article:published_time" content="2024-07-07T14:26:30.000Z"><meta property="article:modified_time" content="2024-08-20T01:32:28.354Z"><meta property="article:author" content="58Q83"><meta property="article:tag" content="编译原理"><meta property="article:tag" content="Java"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://example.com/img/Ada.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/post/38d18c3f.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>let GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:void 0,translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!1,isAnchor:!1,percent:{toc:!0,rightside:!1},autoDarkmode:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"SysY to LLVM简易编译器文档",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-08-20 09:32:28"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,t={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(t)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{let a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.getCSS=(o,n=!1)=>new Promise((t,e)=>{let a=document.createElement("link");a.rel="stylesheet",a.href=o,n&&(a.id=n),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script><meta name="generator" content="Hexo 6.0.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/Ada.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background:rgba(255,255,255,.4)"><nav id="nav"><span id="blog-info"><a href="/" title="58Q83"></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">SysY to LLVM简易编译器文档</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-07T14:26:30.000Z" title="发表于 2024-07-07 22:26:30">2024-07-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-08-20T01:32:28.354Z" title="更新于 2024-08-20 09:32:28">2024-08-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java/">Java</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="SysY to LLVM简易编译器文档"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1>1.编译器简介</h1><h2 id="1-简介">(1) 简介</h2><blockquote><p>该编译器通过Java语言，实现了词法分析，语法分析，符号表管理与错误处理，llvm代码生成功能，将输入的简化的符合SysY语法的代码转换为LLVM语言。<br>具体语法见<a href="/post/9bba8236.html">文法定义及相关说明</a></p></blockquote><h2 id="2-错误处理">(2) 错误处理</h2><blockquote><p>本编译器共可处理10种错误具体如下:</p></blockquote><table><thead><tr><th>错误类型</th><th>错误代码</th><th>解释</th></tr></thead><tbody><tr><td>非法符号</td><td>a</td><td>格式字符串中出现非法字符，如&amp;等，报错行号为<formatstring>所在行数</formatstring></td></tr><tr><td>名字重定义</td><td>b</td><td>函数名或者变量名在当前作用域下重复定义</td></tr><tr><td>未定义的名字</td><td>c</td><td>使用了未定义的标识符报错行号为<ident>所在行数</ident></td></tr><tr><td>函数参数个数不匹配</td><td>d</td><td>函数调用语句中，参数个数与函数定义中的参数个数不匹配</td></tr><tr><td>函数参数类型不匹配</td><td>e</td><td>函数调用语句中，参数类型与函数定义中对应位置的参数类型不匹配</td></tr><tr><td>无返回值的函数存在不匹配的return语句</td><td>f</td><td>报错行号为‘return’所在行号</td></tr><tr><td>有返回值的函数缺少return语句</td><td>g</td><td>只需要考虑函数末尾是否存在return语句，无需考虑数据流</td></tr><tr><td>不能改变常量的值</td><td>h</td><td><lval>为常量时，不能对其修改。报错行号为<lval>所在行号</lval></lval></td></tr><tr><td>缺少分号</td><td>i</td><td>报错行号为分号前一个非终结符所在行号</td></tr><tr><td>缺少右小括号</td><td>j</td><td>报错行号为右小括号前一个非终结符所在行号</td></tr><tr><td>缺少右中括号</td><td>k</td><td>报错行号为右中括号前一个非终结符所在行号</td></tr><tr><td>printf中格式字符与表达式个数不匹配</td><td>l</td><td>报错行号为‘printf’所在行号</td></tr><tr><td>在非循环块中使用break和 continue语句</td><td>m</td><td>报错行号为‘break’与’continue’所在行号</td></tr></tbody></table><h2 id="3-生成结果展示">(3) 生成结果展示</h2><h3 id="输入代码">输入代码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> a[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">10</span>;i = i + <span class="number">1</span>)&#123;</span><br><span class="line">        a[i] = getint();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">10</span>;i = i+<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;test%d\n&quot;</span>,i);</span><br><span class="line">        <span class="type">int</span> b;</span><br><span class="line">        b = a[i] - i;</span><br><span class="line">        <span class="keyword">if</span>(b &gt;= <span class="number">5</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;a[i] - i &gt; 5\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="输出">输出</h3><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="type">i32</span> <span class="title">@getint</span>()</span><br><span class="line"><span class="keyword">declare</span> <span class="type">void</span> <span class="title">@putint</span>(<span class="type">i32</span>)</span><br><span class="line"><span class="keyword">declare</span> <span class="type">void</span> <span class="title">@putch</span>(<span class="type">i32</span>)</span><br><span class="line"><span class="keyword">declare</span> <span class="type">void</span> <span class="title">@putstr</span>(<span class="type">i8</span>*)</span><br><span class="line"></span><br><span class="line"><span class="keyword">define</span> dso_local <span class="type">i32</span> <span class="title">@main</span>() &#123; </span><br><span class="line">	<span class="variable">%x1</span> <span class="operator">=</span> <span class="keyword">alloca</span> <span class="type">i32</span></span><br><span class="line">	<span class="keyword">store</span> <span class="type">i32</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x1</span></span><br><span class="line">	<span class="variable">%x2</span> <span class="operator">=</span> <span class="keyword">alloca</span> [<span class="number">10</span> <span class="keyword">x</span> <span class="type">i32</span>] <span class="comment">;</span></span><br><span class="line">	<span class="keyword">br</span> <span class="type">label</span> <span class="variable">%block1</span></span><br><span class="line"></span><br><span class="line">block<span class="number">1</span>:</span><br><span class="line">	<span class="variable">%x3</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x1</span></span><br><span class="line">	<span class="keyword">store</span> <span class="type">i32</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x1</span></span><br><span class="line">	<span class="keyword">br</span> <span class="type">label</span> <span class="variable">%block2</span></span><br><span class="line"></span><br><span class="line">block<span class="number">2</span>:</span><br><span class="line">	<span class="variable">%x4</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x1</span></span><br><span class="line">	<span class="variable">%x5</span> <span class="operator">=</span> <span class="keyword">icmp</span> <span class="keyword">slt</span> <span class="type">i32</span> <span class="variable">%x4</span><span class="punctuation">,</span> <span class="number">10</span></span><br><span class="line">	<span class="variable">%x6</span> <span class="operator">=</span> <span class="keyword">zext</span> <span class="type">i1</span> <span class="variable">%x5</span> <span class="keyword">to</span> <span class="type">i32</span></span><br><span class="line">	<span class="variable">%x7</span> <span class="operator">=</span> <span class="keyword">icmp</span> <span class="keyword">ne</span> <span class="type">i32</span> <span class="number">0</span><span class="punctuation">,</span> <span class="variable">%x6</span></span><br><span class="line">	<span class="keyword">br</span> <span class="type">i1</span> <span class="variable">%x7</span><span class="punctuation">,</span> <span class="type">label</span> <span class="variable">%block3</span><span class="punctuation">,</span> <span class="type">label</span> <span class="variable">%block4</span></span><br><span class="line"></span><br><span class="line">block<span class="number">3</span>:</span><br><span class="line">	<span class="variable">%x9</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x1</span></span><br><span class="line">	<span class="variable">%x10</span> <span class="operator">=</span> <span class="keyword">getelementptr</span> [<span class="number">10</span> <span class="keyword">x</span> <span class="type">i32</span>]<span class="punctuation">,</span> [<span class="number">10</span> <span class="keyword">x</span> <span class="type">i32</span>]*<span class="variable">%x2</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="variable">%x9</span></span><br><span class="line">	<span class="variable">%x11</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x10</span></span><br><span class="line">	<span class="variable">%x12</span> <span class="operator">=</span> <span class="keyword">call</span> <span class="type">i32</span> <span class="title">@getint</span>()</span><br><span class="line">	<span class="keyword">store</span> <span class="type">i32</span> <span class="variable">%x12</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x10</span></span><br><span class="line">	<span class="keyword">br</span> <span class="type">label</span> <span class="variable">%block5</span></span><br><span class="line"></span><br><span class="line">block<span class="number">5</span>:</span><br><span class="line">	<span class="variable">%x13</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x1</span></span><br><span class="line">	<span class="variable">%x14</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x1</span></span><br><span class="line">	<span class="variable">%x15</span> <span class="operator">=</span> <span class="keyword">add</span> <span class="type">i32</span> <span class="variable">%x14</span><span class="punctuation">,</span> <span class="number">1</span></span><br><span class="line">	<span class="keyword">store</span> <span class="type">i32</span> <span class="variable">%x15</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x1</span></span><br><span class="line">	<span class="keyword">br</span> <span class="type">label</span> <span class="variable">%block2</span></span><br><span class="line"></span><br><span class="line">block<span class="number">4</span>:</span><br><span class="line">	<span class="keyword">br</span> <span class="type">label</span> <span class="variable">%block6</span></span><br><span class="line"></span><br><span class="line">block<span class="number">6</span>:</span><br><span class="line">	<span class="variable">%x16</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x1</span></span><br><span class="line">	<span class="keyword">store</span> <span class="type">i32</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x1</span></span><br><span class="line">	<span class="keyword">br</span> <span class="type">label</span> <span class="variable">%block7</span></span><br><span class="line"></span><br><span class="line">block<span class="number">7</span>:</span><br><span class="line">	<span class="variable">%x17</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x1</span></span><br><span class="line">	<span class="variable">%x18</span> <span class="operator">=</span> <span class="keyword">icmp</span> <span class="keyword">slt</span> <span class="type">i32</span> <span class="variable">%x17</span><span class="punctuation">,</span> <span class="number">10</span></span><br><span class="line">	<span class="variable">%x19</span> <span class="operator">=</span> <span class="keyword">zext</span> <span class="type">i1</span> <span class="variable">%x18</span> <span class="keyword">to</span> <span class="type">i32</span></span><br><span class="line">	<span class="variable">%x20</span> <span class="operator">=</span> <span class="keyword">icmp</span> <span class="keyword">ne</span> <span class="type">i32</span> <span class="number">0</span><span class="punctuation">,</span> <span class="variable">%x19</span></span><br><span class="line">	<span class="keyword">br</span> <span class="type">i1</span> <span class="variable">%x20</span><span class="punctuation">,</span> <span class="type">label</span> <span class="variable">%block8</span><span class="punctuation">,</span> <span class="type">label</span> <span class="variable">%block9</span></span><br><span class="line"></span><br><span class="line">block<span class="number">8</span>:</span><br><span class="line">	<span class="variable">%x22</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x1</span></span><br><span class="line">	<span class="keyword">call</span> <span class="type">void</span> <span class="title">@putch</span>(<span class="type">i32</span> <span class="number">116</span>)</span><br><span class="line">	<span class="keyword">call</span> <span class="type">void</span> <span class="title">@putch</span>(<span class="type">i32</span> <span class="number">101</span>)</span><br><span class="line">	<span class="keyword">call</span> <span class="type">void</span> <span class="title">@putch</span>(<span class="type">i32</span> <span class="number">115</span>)</span><br><span class="line">	<span class="keyword">call</span> <span class="type">void</span> <span class="title">@putch</span>(<span class="type">i32</span> <span class="number">116</span>)</span><br><span class="line">	<span class="keyword">call</span> <span class="type">void</span> <span class="title">@putint</span>(<span class="type">i32</span> <span class="variable">%x22</span>)</span><br><span class="line">	<span class="keyword">call</span> <span class="type">void</span> <span class="title">@putch</span>(<span class="type">i32</span> <span class="number">10</span>)</span><br><span class="line">	<span class="variable">%x23</span> <span class="operator">=</span> <span class="keyword">alloca</span> <span class="type">i32</span></span><br><span class="line">	<span class="variable">%x24</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x23</span></span><br><span class="line">	<span class="variable">%x25</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x1</span></span><br><span class="line">	<span class="variable">%x26</span> <span class="operator">=</span> <span class="keyword">getelementptr</span> [<span class="number">10</span> <span class="keyword">x</span> <span class="type">i32</span>]<span class="punctuation">,</span> [<span class="number">10</span> <span class="keyword">x</span> <span class="type">i32</span>]*<span class="variable">%x2</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="number">0</span><span class="punctuation">,</span> <span class="type">i32</span> <span class="variable">%x25</span></span><br><span class="line">	<span class="variable">%x27</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x26</span></span><br><span class="line">	<span class="variable">%x28</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x1</span></span><br><span class="line">	<span class="variable">%x29</span> <span class="operator">=</span> <span class="keyword">sub</span> <span class="type">i32</span> <span class="variable">%x27</span> <span class="punctuation">,</span><span class="variable">%x28</span></span><br><span class="line">	<span class="keyword">store</span> <span class="type">i32</span> <span class="variable">%x29</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x23</span></span><br><span class="line">	<span class="keyword">br</span> <span class="type">label</span> <span class="variable">%block11</span></span><br><span class="line"></span><br><span class="line">block<span class="number">11</span>:</span><br><span class="line">	<span class="variable">%x30</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x23</span></span><br><span class="line">	<span class="variable">%x31</span> <span class="operator">=</span> <span class="keyword">icmp</span> <span class="keyword">sge</span> <span class="type">i32</span> <span class="variable">%x30</span><span class="punctuation">,</span> <span class="number">5</span></span><br><span class="line">	<span class="variable">%x32</span> <span class="operator">=</span> <span class="keyword">zext</span> <span class="type">i1</span> <span class="variable">%x31</span> <span class="keyword">to</span> <span class="type">i32</span></span><br><span class="line">	<span class="variable">%x33</span> <span class="operator">=</span> <span class="keyword">icmp</span> <span class="keyword">ne</span> <span class="type">i32</span> <span class="number">0</span><span class="punctuation">,</span> <span class="variable">%x32</span></span><br><span class="line">	<span class="keyword">br</span> <span class="type">i1</span> <span class="variable">%x33</span><span class="punctuation">,</span> <span class="type">label</span> <span class="variable">%block12</span><span class="punctuation">,</span> <span class="type">label</span> <span class="variable">%block13</span></span><br><span class="line"></span><br><span class="line">block<span class="number">12</span>:</span><br><span class="line">	<span class="keyword">call</span> <span class="type">void</span> <span class="title">@putch</span>(<span class="type">i32</span> <span class="number">97</span>)</span><br><span class="line">	<span class="keyword">call</span> <span class="type">void</span> <span class="title">@putch</span>(<span class="type">i32</span> <span class="number">91</span>)</span><br><span class="line">	<span class="keyword">call</span> <span class="type">void</span> <span class="title">@putch</span>(<span class="type">i32</span> <span class="number">105</span>)</span><br><span class="line">	<span class="keyword">call</span> <span class="type">void</span> <span class="title">@putch</span>(<span class="type">i32</span> <span class="number">93</span>)</span><br><span class="line">	<span class="keyword">call</span> <span class="type">void</span> <span class="title">@putch</span>(<span class="type">i32</span> <span class="number">32</span>)</span><br><span class="line">	<span class="keyword">call</span> <span class="type">void</span> <span class="title">@putch</span>(<span class="type">i32</span> <span class="number">45</span>)</span><br><span class="line">	<span class="keyword">call</span> <span class="type">void</span> <span class="title">@putch</span>(<span class="type">i32</span> <span class="number">32</span>)</span><br><span class="line">	<span class="keyword">call</span> <span class="type">void</span> <span class="title">@putch</span>(<span class="type">i32</span> <span class="number">105</span>)</span><br><span class="line">	<span class="keyword">call</span> <span class="type">void</span> <span class="title">@putch</span>(<span class="type">i32</span> <span class="number">32</span>)</span><br><span class="line">	<span class="keyword">call</span> <span class="type">void</span> <span class="title">@putch</span>(<span class="type">i32</span> <span class="number">62</span>)</span><br><span class="line">	<span class="keyword">call</span> <span class="type">void</span> <span class="title">@putch</span>(<span class="type">i32</span> <span class="number">32</span>)</span><br><span class="line">	<span class="keyword">call</span> <span class="type">void</span> <span class="title">@putch</span>(<span class="type">i32</span> <span class="number">53</span>)</span><br><span class="line">	<span class="keyword">call</span> <span class="type">void</span> <span class="title">@putch</span>(<span class="type">i32</span> <span class="number">10</span>)</span><br><span class="line">	<span class="keyword">br</span> <span class="type">label</span> <span class="variable">%block13</span></span><br><span class="line"></span><br><span class="line">block<span class="number">13</span>:</span><br><span class="line">	<span class="keyword">br</span> <span class="type">label</span> <span class="variable">%block10</span></span><br><span class="line"></span><br><span class="line">block<span class="number">10</span>:</span><br><span class="line">	<span class="variable">%x35</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x1</span></span><br><span class="line">	<span class="variable">%x36</span> <span class="operator">=</span> <span class="keyword">load</span> <span class="type">i32</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x1</span></span><br><span class="line">	<span class="variable">%x37</span> <span class="operator">=</span> <span class="keyword">add</span> <span class="type">i32</span> <span class="variable">%x36</span><span class="punctuation">,</span> <span class="number">1</span></span><br><span class="line">	<span class="keyword">store</span> <span class="type">i32</span> <span class="variable">%x37</span><span class="punctuation">,</span> <span class="type">i32</span>* <span class="variable">%x1</span></span><br><span class="line">	<span class="keyword">br</span> <span class="type">label</span> <span class="variable">%block7</span></span><br><span class="line"></span><br><span class="line">block<span class="number">9</span>:</span><br><span class="line">	<span class="keyword">ret</span> <span class="type">i32</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>2.编译器的总体设计</h1><h2 id="1-总体结构">(1) 总体结构</h2><blockquote><p>程序总体架构如图：</p><img src="/post/38d18c3f/image-1.png"><br><p>程序运行后通过词法分析生成WordList, 输入到语法分析中生成Ast(抽象语法树),将Ast输入到错误处理部分中构建符号表，进行错误处理，无错误的抽象语法树会传入到代码生成部分生成LLVM代码,若存在错误则输出错误后程序结束，所有模块皆可通过调用Writer模块输出本模块的处理结果</p><ul><li>Writer：将结果输出到对应文件</li><li>词法分析：遍历按行读入testfile.txt中源程序，经过词法分析得到WordList</li><li>语法分析：遍历WordList递归下降生成抽象语法树</li><li>错误处理：遍历抽象语法树，构建符号表进行错误处理</li><li>代码生成：遍历抽象语法树，生成LLVM代码</li></ul></blockquote><h2 id="2-接口设计">(2) 接口设计</h2><blockquote><p>项目文件组成和类与接口示意图如下：</p><img src="/post/38d18c3f/2.png"><ul><li>Compiler:程序入口</li><li>Writer:文件写入模块，用于输出各模块处理结果</li><li>Lexer:词法分析模块</li><li>Parse:语法分析模块</li><li>Vistor:错误处理模块</li><li>Llvmgenerator:代码生成模块</li><li>词法分析相关类：<ul><li>Word:单词类，含该词的类别，内容，行号字段</li><li>WordType:枚举类，枚举单词类别</li></ul></li><li>语法分析相关类:<ul><li>SyntaxWord:抽象语法树节点，用于构建抽象语法树</li></ul></li><li>错误处理相关类：<ul><li>error:错误类，包含行号，错误类型字段</li><li>ErrorLog:错误输出单例，内含ArrayList<error>,用于储存所有错误，及用于错误输出的接口</error></li><li>Symbol:符号类，内含构建符号表所需字段</li><li>SymbolTable:符号表类</li></ul></li><li>代码生成相关:<ul><li>Symbol2:代码生成所使用的符号类，内含用于代码生成的符号信息</li><li>AddIR,MultIR···ZextIR:计算相关的llvmIR类，用于输出对应LLVM语句</li><li>BrIR,CallIR,IcmpIR,ReturnIR:跳转相关的llvmIR类，用于输出对应LLVM语句</li><li>AllocaIR,LoadIR,StoreIR:存储相关的llvmIR类，用于输出对应LLVM语句</li></ul></li></ul></blockquote><h2 id="3-文件组织">(3) 文件组织</h2><blockquote><p>程序文件结构如下:</p><img src="/post/38d18c3f/image-1.png" title="Alt text"><ul><li>Compiler.java:程序入口</li><li>testfile.txt:待编译的源程序</li><li>output.txt:语法分析结果</li><li>error.txt:错误信息</li><li>llvm_ir.txt:llvm代码输出</li></ul></blockquote><h1>3.词法分析设计</h1><h2 id="编码前设计">编码前设计</h2><blockquote><p>编码前设计Lexer模块逻辑如下：</p><img src="/post/38d18c3f/image-2.png" title="Alt text"><p>由Compiler模块持续按行读入文件，将读入行内容和行号传入Lexer模块，Lexer模块循环读入单个字符进行处理</p></blockquote><h2 id="编码后修改">编码后修改</h2><blockquote><p>对于各类符号单词，原本设计存入HashMap中，传入该分支后用if else 进行分类处理，后改为使用LinkedHashMap，在处理完其他情况后使用for循环遍历处理，缩短了代码行数，提高了代码的简洁性。<br>对于注释的处理原本设计使用预读，逻辑为对读取到的’/‘的后继符号进行判断，若存在’/‘则为单行注释，存在’*‘为多行注释，其他情况则当前’/‘当做除号处理，回退读指针，编码完成后多次测试发现存在bug，未考虑到’/'为该行末尾符号，无后继符号，应当作为除号处理，后添加对行末符号的判断处理逻辑。</p></blockquote><h1>4.语法分析设计</h1><h2 id="编码前设计-2">编码前设计</h2><blockquote><p>向Parse模块中传入Lexer模块生成的WordList，遍历该列表的单词，递归下降处理各语法成分，对于含有左递归的文法，如AddExp,LOrExp等，为解决回溯问题使用预读进行处理。</p></blockquote><h2 id="编码后修改-2">编码后修改</h2><h3 id="1-左递归文法">1.左递归文法</h3><blockquote><p>对于处理左递归的方式，实际选用如下方式处理。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> SyntaxWord <span class="title function_">AddExp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">SyntaxWord</span> <span class="variable">addExp</span> <span class="operator">=</span> createMiddle(<span class="string">&quot;AddExp&quot;</span>);</span><br><span class="line">        <span class="type">SyntaxWord</span> <span class="variable">Father</span> <span class="operator">=</span> createMiddle(<span class="string">&quot;AddExp&quot;</span>);</span><br><span class="line">        addExp.addChild(MulExp());</span><br><span class="line">        <span class="keyword">while</span> (symTpyeCheck(sym, WordType.PLUS) || symTpyeCheck(sym, WordType.MINU))&#123;</span><br><span class="line">            Father.addChild(addExp);</span><br><span class="line">            res.add(<span class="string">&quot;&lt;AddExp&gt;&quot;</span>);</span><br><span class="line">            Father.addChild(createTerminal(sym));<span class="comment">// + -</span></span><br><span class="line">            addExp = Father;</span><br><span class="line">            nextSym();</span><br><span class="line">            addExp.addChild(MulExp());</span><br><span class="line">        &#125;</span><br><span class="line">        res.add(<span class="string">&quot;&lt;AddExp&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> addExp;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>对于需要处理的AddExp，当前单词直接当做MulExp处理，添加到当前AddExp的子节点中，若该单词后继为’+‘||’-',则为当前的AddExp(含一MulExp的子节点)创建一个AddExp的父节点Father，为运算符号创建节点，添加仅Father，将后继单词作为MulExp处理，添加仅Father节点，最后返回Father节点。显然<code>Father</code>节点只在<code>while</code>循环外创建了一次，由于<code>Father.addChild(addExp);</code> <code>addExp = Father;</code>，当循环第二次运行时，<code>Father</code>节点与<code>addExp</code>节点是相同的，导致addExp中一子节点会指向自己，导致在遍历语法树的时候死循环，且由于在语法分析部分，处理结果都是在递归下降过程中添加字符串到res数组中，最后遍历输出数组产生，而不是由遍历抽象语法树生成，导致此Bug没有被发现，且由于Father节点在while循环之外被创建，对于例如<code>1+1</code>的输入可以生成期望的抽象语法树,但对于多层AddExp嵌套，如输入<code>2+3-4+5</code>会生成错误的语法树。</p><img src="/post/38d18c3f/3.jpg" title="树状图"><p>错误情况: AddExp的Child中存在自身，遍历树的时候产生死循环</p><img src="/post/38d18c3f/4.jpg"><p>后修复为如下代码,在<code>while</code>循环中新建<code>Father</code>对象，使得多次循环中<code>Father</code>改变，不会导致<code>addExp</code>的child中有指向自己的变量。其余含左递归的文法皆做相同处理修复BUG。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> SyntaxWord <span class="title function_">AddExp</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">SyntaxWord</span> <span class="variable">addExp</span> <span class="operator">=</span> createMiddle(<span class="string">&quot;AddExp&quot;</span>);</span><br><span class="line">    addExp.addChild(MulExp());</span><br><span class="line">    <span class="keyword">while</span> (symTpyeCheck(sym, WordType.PLUS) || symTpyeCheck(sym, WordType.MINU)) &#123;</span><br><span class="line">        <span class="type">SyntaxWord</span> <span class="variable">Father</span> <span class="operator">=</span> createMiddle(<span class="string">&quot;AddExp&quot;</span>); <span class="comment">// 创建新的 Father 对象</span></span><br><span class="line">        Father.addChild(addExp);</span><br><span class="line">        res.add(<span class="string">&quot;&lt;AddExp&gt;&quot;</span>);</span><br><span class="line">        Father.addChild(createTerminal(sym)); <span class="comment">// + -</span></span><br><span class="line">        nextSym();</span><br><span class="line">        Father.addChild(MulExp());</span><br><span class="line">        addExp = Father; <span class="comment">// 将 addExp 更新为新的 Father</span></span><br><span class="line">    &#125;</span><br><span class="line">    res.add(<span class="string">&quot;&lt;AddExp&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> addExp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-Stmt处理">2.Stmt处理</h3><blockquote><p>在处理Stmt的<code>[Exp];</code>和<code>LVal = Exp;</code>情况时，由于LVal和Exp的First集都含有Ident，对判断逻辑的编码产生了很大阻碍，最后采取对读取到的Ident记录其下标，并都按照LVal处理建立对应节点，当为<code>[Exp];</code>情况时则不将LVal节点加入Stmt的子节点中，同时调用<code>back</code>函数清除添加到res数组中的错误字符串,在<code>back</code>函数编写过程中，起先未考虑到LVal可能由多个终结符构成，即LVal为数组时，Ident后续的单词也会被加入LVal的子节点中，这些结果也是错误的需要回退，最终修改为如下代码,正确处理了Stmt节点，解决了<code>back</code>函数的BUG。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (symTpyeCheck(sym, WordType.IDENFR)) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">resNowSize</span> <span class="operator">=</span> res.size();</span><br><span class="line">            <span class="type">int</span> <span class="variable">oldIndex</span> <span class="operator">=</span> index;<span class="comment">//记录处理前指针位置</span></span><br><span class="line">            <span class="type">SyntaxWord</span> <span class="variable">tmp</span> <span class="operator">=</span> LVAL();</span><br><span class="line">            <span class="keyword">if</span> (symTpyeCheck(sym, WordType.ASSIGN))&#123;<span class="comment">//存在= ,为LVal = 情况，tmp为LVAl</span></span><br><span class="line">                stmt.addChild(tmp);</span><br><span class="line">                stmt.addChild(createTerminal(sym));</span><br><span class="line">                nextSym();</span><br><span class="line">                <span class="comment">// LVal = getint()</span></span><br><span class="line">                <span class="keyword">if</span>(symTpyeCheck(sym,WordType.GETINTTK))&#123;</span><br><span class="line">                    stmt.setStmtType(<span class="string">&quot;Input&quot;</span>);</span><br><span class="line">                    stmt.addChild(createTerminal(sym));</span><br><span class="line">                    nextSym();</span><br><span class="line">                    <span class="keyword">if</span>(symTpyeCheck(sym, WordType.LPARENT))&#123;<span class="comment">//(</span></span><br><span class="line">                        stmt.addChild(createTerminal(sym));</span><br><span class="line">                        nextSym();</span><br><span class="line">                        <span class="keyword">if</span> (symTpyeCheck(sym, WordType.RPARENT))&#123;<span class="comment">//)</span></span><br><span class="line">                            stmt.addChild(createTerminal(sym));</span><br><span class="line">                            nextSym();</span><br><span class="line">                            <span class="keyword">if</span> (symTpyeCheck(sym, WordType.SEMICN))&#123;<span class="comment">//;</span></span><br><span class="line">                                stmt.addChild(createTerminal(sym));</span><br><span class="line">                                nextSym();</span><br><span class="line">                            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                                ErrorLog.instance.addError(getPreWordLine(), <span class="string">&quot;i&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                            ErrorLog.instance.addError(getPreWordLine(), <span class="string">&quot;j&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;<span class="comment">// LVal = Exp;</span></span><br><span class="line">                    stmt.setStmtType(<span class="string">&quot;Assignment&quot;</span>);</span><br><span class="line">                    stmt.addChild(Exp());</span><br><span class="line">                    <span class="keyword">if</span> (symTpyeCheck(sym, WordType.SEMICN))&#123;</span><br><span class="line">                        stmt.addChild(createTerminal(sym));</span><br><span class="line">                        nextSym();</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        ErrorLog.instance.addError(getPreWordLine(), <span class="string">&quot;i&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;<span class="comment">//不存在=,为Exp;情况</span></span><br><span class="line">                back(resNowSize, oldIndex);<span class="comment">//回退当前指针与添加的结果res</span></span><br><span class="line">                stmt.setStmtType(<span class="string">&quot;Exp&quot;</span>);</span><br><span class="line">                stmt.addChild(Exp());</span><br><span class="line">                <span class="keyword">if</span>(symTpyeCheck(sym, WordType.SEMICN))&#123;<span class="comment">//;</span></span><br><span class="line">                    stmt.addChild(createTerminal(sym));</span><br><span class="line">                    nextSym();</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="comment">//e</span></span><br><span class="line">                    ErrorLog.instance.addError(getPreWordLine(), <span class="string">&quot;i&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">back</span><span class="params">(<span class="type">int</span> oldSize, <span class="type">int</span> oldIndex)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">nowSize</span> <span class="operator">=</span> res.size();</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> nowSize - <span class="number">1</span>; i &gt;= oldSize; i--)&#123;</span><br><span class="line">        res.remove(i);</span><br><span class="line">    &#125;</span><br><span class="line">    index = oldIndex - <span class="number">1</span>;<span class="comment">//index - (index - oldIndex + 1)</span></span><br><span class="line">    nextSym();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>5.错误处理设计</h1><h2 id="编码前设计-3">编码前设计</h2><blockquote><p>经对所有错误类型分析，做出如下分配，a类错误在Lexer模块中处理，i,j,k类错误在Parse模块中处理，其余在错误在模块Vistor中处理。分析发现构建符号表仅需要对抽象语法树中<code>FuncDef、Block、VarDef、MainFuncDef、LVal、Stmt、ConstDef、UnaryExp</code>节点进行处理则设计编写<code>traverseTree</code>函数对抽象语法树前序遍历，<code>handle</code>函数使用if else对节点进行分类处理。设计符号类如下:</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Symbol</span> &#123;</span><br><span class="line">    <span class="keyword">private</span>  String token;<span class="comment">//当前单词所对应的字符串</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> type;<span class="comment">//用于区分LVal类型或获取数组维度，其中0 -&gt; a, 1 -&gt; a[], 2 -&gt; a[][], -1 -&gt; func</span></span><br><span class="line">    <span class="keyword">private</span>  <span class="type">int</span> con;<span class="comment">//是否为const，其中1 -&gt; const, 0 -&gt; var </span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isFunc</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Func</span>&#123;<span class="comment">//  type == -1时使用，存放函数相关信息</span></span><br><span class="line">        <span class="type">int</span> retype;<span class="comment">// 0 -&gt; int, 1-&gt;void</span></span><br><span class="line">        <span class="type">int</span> paramNum; <span class="comment">//参数数量</span></span><br><span class="line">        ArrayList&lt;Symbol&gt; parameters;<span class="comment">//参数符号数组</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Func</span> <span class="variable">func</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Func</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Symbol</span><span class="params">(String token, <span class="type">int</span> type, <span class="type">int</span> con)</span>&#123;<span class="comment">//创建普通符号</span></span><br><span class="line">        <span class="built_in">this</span>.con = con;</span><br><span class="line">        <span class="built_in">this</span>.token = token;</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Symbol</span><span class="params">(String token, <span class="type">int</span> type, <span class="type">int</span> con, <span class="type">int</span> retype, <span class="type">int</span> paramNum, ArrayList&lt;Symbol&gt; parameters)</span>&#123;<span class="comment">//创建函数符号</span></span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">        <span class="built_in">this</span>.token = token;</span><br><span class="line">        <span class="built_in">this</span>.con = con;</span><br><span class="line">        <span class="built_in">this</span>.func.parameters = parameters;</span><br><span class="line">        <span class="built_in">this</span>.func.paramNum = paramNum;</span><br><span class="line">        <span class="built_in">this</span>.func.retype = retype;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>对于符号表，使用<code>HashMap&lt;Interger, SymbolTable&gt; floor_symbolTable</code>存储符号表类，floor对程序层级进行计数，处理到Block则<code>floor++</code>,处理完毕后<code>floor--</code>, 对于函数，使用<code>HashMap&lt;String, Symbol&gt; funcName2Symbol</code>存储函数名对应的符号表，<code>HashMap&lt;String, Table&gt; funcName2parTable</code> 存储函数名对应的参数符号表。</p></blockquote><h2 id="编码后修改-3">编码后修改</h2><h3 id="1-符号表实现">1.符号表实现</h3><blockquote><p>实际编码中对符号表结构做出修改，不使用预先设计的<code>HashMap&lt;Interger, SymbolTable&gt; floor_symbolTable</code>存储符号表实现符号表嵌套关系，而是在符号表类中添加其父符号表指针，使用全局变量<code>curTable</code>指向当前处理的符号表，<code>globelTable</code>指向最顶级的符号表,符号表类设计如下:</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SymbolTable</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">FuncName</span> <span class="operator">=</span> <span class="literal">null</span>;<span class="comment">//函数名</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">SymbolTable</span> <span class="variable">globelTable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SymbolTable</span>();<span class="comment">//顶层符号表</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">SymbolTable</span> <span class="variable">Father</span> <span class="operator">=</span> <span class="literal">null</span>;<span class="comment">//父级符号表</span></span><br><span class="line">    HashMap&lt;String, Symbol&gt; name_symbol = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();<span class="comment">//参数名，对应符号表，处理函数参数时使用</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isLoop</span> <span class="operator">=</span> <span class="literal">false</span>;<span class="comment">//当前符号表是否为循环</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">needReturn</span> <span class="operator">=</span> <span class="literal">false</span>;<span class="comment">//当前符号表是否需要return语句</span></span><br><span class="line">    <span class="keyword">public</span> SymbolTable <span class="title function_">getFather</span><span class="params">()</span>&#123;<span class="keyword">return</span> Father;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">exist</span><span class="params">(String name)</span>&#123;<span class="comment">//是否存在该函数名的参数</span></span><br><span class="line">        <span class="keyword">return</span> name_symbol.containsKey(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Symbol <span class="title function_">getSymbol</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name_symbol.getOrDefault(name, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSymbol</span><span class="params">(String name,Symbol tmp)</span>&#123;</span><br><span class="line">        name_symbol.put(name, tmp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getFName</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> FuncName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFuncName</span><span class="params">(String s)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.FuncName = s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIsLoop</span><span class="params">(<span class="type">boolean</span> flag)</span>&#123;</span><br><span class="line">        isLoop = flag;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">getIsLoop</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isLoop;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="for循环语句处理">for循环语句处理</h3><blockquote><p>在编码中对于<code>Stmt -&gt; 'for' '(' [ForStmt] ';' [Cond] ';' [forStmt] ')' Stmt</code>情况中最后的Stmt节点直接默认其为<code>Stmt -&gt; Block</code>情况，未考虑如下情况且通过了错误处理测试，导致后续开启错误处理代码生成时产生BUG。</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//for语句后非Block情况</span></span><br><span class="line"><span class="keyword">for</span>(;;); </span><br><span class="line"></span><br><span class="line"><span class="type">int</span> i,j;</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; <span class="number">10</span>;i = i + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span>(j = <span class="number">0</span>;j &lt; <span class="number">10</span>;j = j + <span class="number">1</span>)</span><br><span class="line">        ···</span><br></pre></td></tr></table></figure><blockquote><p>对于上述BUG，显然创建新的Block节点加入终结符节点<code>LBRACE</code>，非终结符节点<code>BlockItem</code>及终结符节点<code>RBRACE</code>,将for末尾的Stmt节点从取出添加到新建的<code>BlockItem</code>节点并从父级Stmt节点删除，向父级Stmt节点添加<code>Block</code>节点对程序的运行结果是没有影响的，因此后续添加在处理逻辑中添加了<code>wrapWithBlock</code>函数向其中传入Stmt节点返回用Block包装后的Block节点，对for语句末尾Stmt的类型判断，若为非Block情况则调用<code>wrapWithBlock</code>函数包装后处理。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">Stmt</span><span class="params">(SyntaxWord syntaxWord)</span> &#123;</span><br><span class="line">        ArrayList&lt;SyntaxWord&gt; children = syntaxWord.getChildren();</span><br><span class="line">        <span class="keyword">if</span>(children.get(<span class="number">0</span>).isEnd())&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> syntaxWord.getChild0Content();</span><br><span class="line">            <span class="keyword">if</span>(token.equals(<span class="string">&quot;for&quot;</span>)) &#123;</span><br><span class="line">                <span class="type">SyntaxWord</span> <span class="variable">stmt</span> <span class="operator">=</span> children.get(children.size() - <span class="number">1</span>);</span><br><span class="line">                <span class="comment">//stmt child0 isEnd 或非end type 不是Block时，用block包装后处理</span></span><br><span class="line">                <span class="comment">//new:</span></span><br><span class="line">                <span class="comment">//-------------------------------------------------</span></span><br><span class="line">                <span class="keyword">if</span>(!stmt.isEnd())&#123;</span><br><span class="line">                        <span class="keyword">if</span>(stmt.getChildren().get(<span class="number">0</span>).isEnd() || !stmt.getChildren().get(<span class="number">0</span>).getType().equals(<span class="string">&quot;Block&quot;</span>))&#123;</span><br><span class="line">                            children.remove(children.size() - <span class="number">1</span>);</span><br><span class="line">                            children.add(wrapWithBlock(stmt));</span><br><span class="line">                            stmt = children.get(children.size() - <span class="number">1</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//-------------------------------------------------</span></span><br><span class="line">                <span class="keyword">if</span>(!stmt.isEnd() &amp;&amp; stmt.getChildren().get(<span class="number">0</span>).getType().equals(<span class="string">&quot;Block&quot;</span>))&#123;</span><br><span class="line">                    isLoop = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                stmt.setLoop(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ···</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            ···</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> SyntaxWord <span class="title function_">wrapWithBlock</span><span class="params">(SyntaxWord stmt)</span> &#123;</span><br><span class="line">        <span class="type">SyntaxWord</span> <span class="variable">Stmt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SyntaxWord</span>(<span class="string">&quot;Stmt&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="type">SyntaxWord</span> <span class="variable">L</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SyntaxWord</span>(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Word</span>(-<span class="number">1</span>,WordType.LBRACE.toString(), <span class="string">&quot;&#123;&quot;</span>));</span><br><span class="line">        <span class="type">SyntaxWord</span> <span class="variable">R</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SyntaxWord</span>(<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Word</span>(-<span class="number">1</span>, WordType.RBRACE.toString(), <span class="string">&quot;&#125;&quot;</span>));</span><br><span class="line">        <span class="type">SyntaxWord</span> <span class="variable">blockItem</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SyntaxWord</span>(<span class="string">&quot;BlockItem&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">SyntaxWord</span> <span class="variable">block</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SyntaxWord</span>(<span class="string">&quot;Block&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        blockItem.addChild(stmt);</span><br><span class="line">        block.addChild(L);</span><br><span class="line">        block.addChild(blockItem);</span><br><span class="line">        block.addChild(R);</span><br><span class="line">        Stmt.addChild(block);</span><br><span class="line">        <span class="keyword">return</span> Stmt;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1>6.代码生成设计</h1><h2 id="编码前设计-4">编码前设计</h2><blockquote><p>代码生成选择LLVM IR作为目标代码，设计参考课程网站上的LLVM指导手册。由于用于错误处理的SymbolTable类无法从父级表获得子表，设计用于代码生成的Symbol类如下，同时原抽象语法树节点类添加若干字段。利用LLVM编译时的特性，设计基本块命名为<code>&quot;block&quot; + blockId</code>,即字符串+数字形式，这样在编译时编译器会自动为块重新标号，这样在输出目标代码时可以不用保证块号递增，大大减轻对基本块标号的工作量，例如生成如下目标代码, 其块号不是单调递增的，通过LLVM编译后可正确运行。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">block3:</span><br><span class="line">    ···</span><br><span class="line">    br label %block2</span><br><span class="line">block1:</span><br><span class="line">    ···</span><br><span class="line">    br label %block2</span><br><span class="line">block:</span><br><span class="line">    ···</span><br><span class="line">    ···</span><br></pre></td></tr></table></figure><blockquote><p>Symbol类：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Symbol2</span> &#123;</span><br><span class="line">    <span class="type">int</span> dim;<span class="comment">//维度</span></span><br><span class="line">    <span class="type">int</span> x;<span class="comment">//数组一维大小</span></span><br><span class="line">    <span class="type">int</span> y;<span class="comment">//数组二维大小</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">Addr</span> <span class="operator">=</span> <span class="string">&quot;i32&quot;</span>;<span class="comment">//地址类别,默认为i32</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">intVal</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;<span class="comment">//初始值</span></span><br><span class="line">    ArrayList&lt;String&gt; dim1= <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();<span class="comment">//一维数组内容</span></span><br><span class="line">    String [][] dim2 = <span class="literal">null</span>;<span class="comment">//二维数组内容</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Symbol2</span><span class="params">(<span class="type">int</span> dim)</span>&#123;<span class="comment">//新建普通变量符号</span></span><br><span class="line">        <span class="built_in">this</span>.dim = dim;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Symbol2</span><span class="params">(<span class="type">int</span> dim, <span class="type">int</span> x)</span>&#123;<span class="comment">//新建一维数组符号</span></span><br><span class="line">        <span class="built_in">this</span>.x = x;</span><br><span class="line">        <span class="built_in">this</span>.dim = dim;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Symbol2</span><span class="params">(<span class="type">int</span> dim, <span class="type">int</span> x, <span class="type">int</span> y)</span>&#123;<span class="comment">//新建二维数组符号</span></span><br><span class="line">        <span class="built_in">this</span>.x = x;</span><br><span class="line">        <span class="built_in">this</span>.y = y;</span><br><span class="line">        <span class="built_in">this</span>.dim = dim;</span><br><span class="line">        <span class="keyword">if</span>(x == <span class="number">0</span>)&#123;</span><br><span class="line">            dim2 = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">11111</span>][y];</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            dim2 = <span class="keyword">new</span> <span class="title class_">String</span>[x][y];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAddr</span><span class="params">(String s)</span>&#123;</span><br><span class="line">        Addr = s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDim1</span><span class="params">(ArrayList&lt;String&gt; list)</span> &#123;</span><br><span class="line">        dim1.addAll(list);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;String&gt; <span class="title function_">getDim1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dim1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDim</span><span class="params">(<span class="type">int</span> dim)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.dim = dim;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDim2</span><span class="params">(String[][] dim2)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dim2 = dim2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String[][] getDim2() &#123;</span><br><span class="line">        <span class="keyword">return</span> dim2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAddr</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Addr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getX</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getY</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> y;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getDim</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dim;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIntVal</span><span class="params">(String intVal)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.intVal = intVal;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getIntVal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> intVal;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setX</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.x = x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setY</span><span class="params">(<span class="type">int</span> y)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.y = y;</span><br><span class="line">        <span class="keyword">if</span>(x == <span class="number">0</span>)&#123;</span><br><span class="line">            dim2 = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">11111</span>][y];</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            dim2 = <span class="keyword">new</span> <span class="title class_">String</span>[x][y];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>SyntaxWord类:</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SyntaxWord</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> isLoop;</span><br><span class="line">    Word token;</span><br><span class="line">    String type;</span><br><span class="line">    ArrayList&lt;SyntaxWord&gt; children;.</span><br><span class="line">    <span class="comment">//new:</span></span><br><span class="line">    <span class="type">Symbol2</span> <span class="variable">symbol</span> <span class="operator">=</span> <span class="literal">null</span>;<span class="comment">//新增符号类</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">returnType</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;<span class="comment">//返回类型</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">regId</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>; <span class="comment">//LLVM变量id</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;  <span class="comment">//取值</span></span><br><span class="line">    <span class="type">int</span> TrueId;<span class="comment">// 用于处理条件跳转，为真时跳转的块号</span></span><br><span class="line">    <span class="type">int</span> FalseId;<span class="comment">//为假时跳转的块号</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">StmtId</span> <span class="operator">=</span> -<span class="number">1</span>;<span class="comment">//条件跳转产生的块号</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ContinueId</span> <span class="operator">=</span> -<span class="number">1</span>;<span class="comment">//Continue跳转块号</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">BreakId</span> <span class="operator">=</span> -<span class="number">1</span>;<span class="comment">//Break跳转块号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>继续使用递归下降遍历抽象语法树，处理各个节点,设计<code>handle</code>函数将输入入节点传入对应函数处理，其中LOrExp与LAndExp传入对应函数前记录该节点为顶级父节点，用于实现短路求职。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(SyntaxWord node)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(node.isEnd())&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(node.typeCheck(<span class="string">&quot;CompUnit&quot;</span>) || node.typeCheck(<span class="string">&quot;Decl&quot;</span>) ||node.typeCheck(<span class="string">&quot;ConstDecl&quot;</span>) || node.typeCheck(<span class="string">&quot;VarDecl&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">for</span> (SyntaxWord child:node.getChildren())&#123;</span><br><span class="line">                handle(child);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;ConstDef&quot;</span>))&#123;</span><br><span class="line">            ConstDef(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;ConstInitVal&quot;</span>)) &#123;</span><br><span class="line">            ConstInitVal(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;ConstExp&quot;</span>)) &#123;</span><br><span class="line">            ConstExp(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;VarDef&quot;</span>))&#123;</span><br><span class="line">            VarDef(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;InitVal&quot;</span>)) &#123;</span><br><span class="line">            InitVal(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;FuncDef&quot;</span>)) &#123;</span><br><span class="line">            FuncDef(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;FuncFParams&quot;</span>))&#123;</span><br><span class="line">            FuncFParams(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;FuncFParam&quot;</span>)) &#123;</span><br><span class="line">            FuncFparam(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;MainFuncDef&quot;</span>)) &#123;</span><br><span class="line">            MainFuncDef(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;Block&quot;</span>)) &#123;</span><br><span class="line">            Block(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;Stmt&quot;</span>)) &#123;</span><br><span class="line">            Stmt(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;ForStmt&quot;</span>)) &#123;</span><br><span class="line">            ForStmt(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;Exp&quot;</span>))&#123;</span><br><span class="line">            Exp(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;Cond&quot;</span>))&#123;</span><br><span class="line">            Cond(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;LVal&quot;</span>)) &#123;</span><br><span class="line">            LVal(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;NumBer&quot;</span>)) &#123;</span><br><span class="line">            Number(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;FuncRParams&quot;</span>))&#123;</span><br><span class="line">            FuncRParams(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;AddExp&quot;</span>)) &#123;</span><br><span class="line">            AddExp(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;MulExp&quot;</span>)) &#123;</span><br><span class="line">            MulExp(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;UnaryExp&quot;</span>))&#123;</span><br><span class="line">            UnaryExp(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;PrimaryExp&quot;</span>)) &#123;</span><br><span class="line">            PrimaryExp(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;LOrExp&quot;</span>)) &#123;</span><br><span class="line">            FatherLOr = node;</span><br><span class="line">            LOrExp(node);</span><br><span class="line">            FatherLOr = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;LAndExp&quot;</span>)) &#123;</span><br><span class="line">            FatherLAnd = node;</span><br><span class="line">            LAndExp(node);</span><br><span class="line">            FatherLAnd = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;EqExp&quot;</span>)) &#123;</span><br><span class="line">            EqExp(node);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.typeCheck(<span class="string">&quot;RelExp&quot;</span>)) &#123;</span><br><span class="line">            RelExp(node);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>对于目标代码设计继承IR接口的各语句类如下:</p><img src="/post/38d18c3f/image-3.png" title="Alt text"><p>重写各类<code>toString</code>方法用于生成对应语句<br>例：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultIR</span> <span class="keyword">implements</span> <span class="title class_">IR</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String op1;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String op2;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">operation</span> <span class="operator">=</span> <span class="string">&quot;mul&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String resReg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MultIR</span><span class="params">(String resReg, String op1, String op2)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.op1 = op1;</span><br><span class="line">        <span class="built_in">this</span>.op2 = op2;</span><br><span class="line">        <span class="built_in">this</span>.resReg = resReg;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;\t&quot;</span> + resReg + <span class="string">&quot; = &quot;</span> + operation + <span class="string">&quot; i32&quot;</span> + <span class="string">&quot; &quot;</span> + op1 +<span class="string">&quot; ,&quot;</span>+op2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>对于仅运算符不同的IR语句设计<code>calIR</code>函数区分对应语句</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">calIR</span><span class="params">(String leftValue, String op, String rightValue)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">Ir</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">resAddress</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">    <span class="keyword">switch</span> (op)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;+&quot;</span>-&gt;&#123;</span><br><span class="line">            Ir = <span class="keyword">new</span> <span class="title class_">AddIR</span>(resAddress, leftValue, rightValue).toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;-&quot;</span>-&gt;&#123;</span><br><span class="line">            Ir = <span class="keyword">new</span> <span class="title class_">SubIR</span>(resAddress, leftValue, rightValue).toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;*&quot;</span>-&gt;&#123;</span><br><span class="line">            Ir = <span class="keyword">new</span> <span class="title class_">MultIR</span>(resAddress, leftValue, rightValue).toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;/&quot;</span>-&gt;&#123;</span><br><span class="line">            Ir = <span class="keyword">new</span> <span class="title class_">SDivIR</span>(resAddress, leftValue, rightValue).toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;%&quot;</span>-&gt;&#123;</span><br><span class="line">            Ir = <span class="keyword">new</span> <span class="title class_">SremIR</span>(resAddress, leftValue, rightValue).toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Ir;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>符号表部分使用栈式符号表，全局变量表，函数表是哪个表实现</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;String, SyntaxWord&gt; global;</span><br><span class="line">ArrayList&lt;SyntaxWord&gt; stack;</span><br><span class="line">HashMap&lt;SyntaxWord, Integer&gt; floorMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br></pre></td></tr></table></figure><blockquote><p>可知代码生成时AddExp与MulExp唯一区别在于中间的运算符号不同，故合并到MulExp中处理,同时一些常数可以直接计算出值在进行代码生成，设计该节点及其子节点是否全为常数的判断逻辑，调用<code>calculateNum</code>函数计算该值。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">AddExp</span><span class="params">(SyntaxWord node)</span> &#123;</span><br><span class="line">        MulExp(node);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">MulExp</span><span class="params">(SyntaxWord node)</span> &#123;</span><br><span class="line">        ArrayList&lt;SyntaxWord&gt; children = node.getChildren();</span><br><span class="line">        <span class="type">SyntaxWord</span> <span class="variable">left</span> <span class="operator">=</span> children.get(<span class="number">0</span>);</span><br><span class="line">        handle(left);</span><br><span class="line">        <span class="type">String</span> <span class="variable">leftValue</span> <span class="operator">=</span> left.getValue();</span><br><span class="line">        <span class="keyword">if</span>(children.size() == <span class="number">1</span>)&#123; <span class="comment">// 单表达式不运算</span></span><br><span class="line">            <span class="comment">//直接向上传值</span></span><br><span class="line">            node.setRegId(left.getRegId());</span><br><span class="line">            node.setValue(leftValue);</span><br><span class="line">            node.setSymbol(left.getSymbol());</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//运算  add-&gt; add (+ || -) mul</span></span><br><span class="line">            <span class="comment">// mul (* || /) Unary</span></span><br><span class="line">            <span class="comment">// 运算后向上传值</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">op</span> <span class="operator">=</span> children.get(<span class="number">1</span>).getToken().getContent();</span><br><span class="line">            <span class="type">SyntaxWord</span> <span class="variable">right</span> <span class="operator">=</span> children.get(<span class="number">2</span>);</span><br><span class="line">            handle(right);</span><br><span class="line">            <span class="type">String</span> <span class="variable">rightValue</span> <span class="operator">=</span> right.getValue();</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isAllNum</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span>(SyntaxWord child:children)&#123;</span><br><span class="line">                <span class="keyword">if</span> (!child.isEnd()&amp;&amp;!isNum(child.getValue()))&#123;</span><br><span class="line">                    isAllNum = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(isAllNum)&#123;</span><br><span class="line">                right.setValue(calculateNum(leftValue, op, rightValue));</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                writeRes(calIR(leftValue, op, rightValue) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                right.setRegId(<span class="string">&quot;%x&quot;</span> + regId);</span><br><span class="line">                right.setValue(<span class="string">&quot;%x&quot;</span> + regId);</span><br><span class="line">                ++regId;</span><br><span class="line">            &#125;</span><br><span class="line">            node.setSymbol(right.getSymbol());</span><br><span class="line">            node.setValue(right.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">calculateNum</span><span class="params">(String leftValue, String op, String rightValue)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> Integer.parseInt(leftValue);</span><br><span class="line">        <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> Integer.parseInt(rightValue);</span><br><span class="line">        <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> <span class="string">&quot;None&quot;</span>;</span><br><span class="line">        <span class="keyword">switch</span>(op)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;+&quot;</span>-&gt;&#123;res = String.valueOf(left + right);&#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;-&quot;</span>-&gt;&#123;res = String.valueOf(left - right);&#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;*&quot;</span>-&gt;&#123;res = String.valueOf(left * right);&#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;/&quot;</span>-&gt;&#123;res = String.valueOf(left / right);&#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;%&quot;</span>-&gt;&#123;res = String.valueOf(left % right);&#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;==&quot;</span>-&gt;&#123; res = String.valueOf((left == right) ? <span class="number">1</span> : <span class="number">0</span>);&#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;!=&quot;</span>-&gt;&#123; res = String.valueOf((left != right) ? <span class="number">1</span> : <span class="number">0</span>);&#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;&gt;&quot;</span>-&gt;&#123; res = String.valueOf((left &gt; right) ? <span class="number">1</span> : <span class="number">0</span>);&#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;&gt;=&quot;</span>-&gt;&#123; res = String.valueOf((left &gt;= right) ? <span class="number">1</span> : <span class="number">0</span>);&#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;&lt;&quot;</span>-&gt;&#123; res = String.valueOf((left &lt; right) ? <span class="number">1</span> : <span class="number">0</span>);&#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;&lt;=&quot;</span>-&gt;&#123; res = String.valueOf((left &lt;= right) ? <span class="number">1</span> : <span class="number">0</span>);&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (res.equals(<span class="string">&quot;None&quot;</span>))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;None result error in caculateNum&quot;</span>);</span><br><span class="line">            System.exit(-<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>短路求值，首先对于LAndExp的抽象语法树，当前节点子节点数为1时即该节点仅有1子节点EqExp，处理该EqExp,向上传值后结束，对于如图形式的抽象语法树,左杈LAnd节点继承其父节点的FalseId，递归处理左杈LAnd，处理完后创建新TrueBlock跳转到右杈EqExp块。当左杈LAnd节点的父节点为顶级LAnd节点时，顶级LAnd的TrueId，FalseId，StmtId同父级LOr节点，则在处理完最后的EqExp后续输出LOr节点对应LLVM IR语句。<br>LOrExp抽象语法树的处理基本同理，仅需注意左杈LOr节点要继承父节点TrueId新建FalseBlock跳转至右杈LAnd，当左杈LOr的父节点为顶级LOr节点时需要输出父级Cond节点对应LLVM IR语句</p><img src="/post/38d18c3f/image-4.png" title="Alt text"> <img src="/post/38d18c3f/image-5.png" title="Alt text"></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">LAndExp</span><span class="params">(SyntaxWord node)</span> &#123;</span><br><span class="line">        <span class="comment">// LAndExp → EqExp | LAndExp &#x27;&amp;&amp;&#x27; EqExp</span></span><br><span class="line">        ArrayList&lt;SyntaxWord&gt; children = node.getChildren();</span><br><span class="line">        <span class="keyword">if</span>(children.size() == <span class="number">1</span>)&#123;<span class="comment">//单节点无需计算直接向上传值</span></span><br><span class="line">            <span class="type">SyntaxWord</span> <span class="variable">eqExp</span> <span class="operator">=</span> children.get(<span class="number">0</span>);</span><br><span class="line">            handle(eqExp);</span><br><span class="line">            node.setValue(eqExp.getValue());</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123; <span class="comment">// 三节点，递归处理后传值</span></span><br><span class="line">            <span class="type">SyntaxWord</span> <span class="variable">lAndExp</span> <span class="operator">=</span> children.get(<span class="number">0</span>);</span><br><span class="line">            lAndExp.setFalseId(node.getFalseId());</span><br><span class="line">            LAndExp(lAndExp);</span><br><span class="line">            <span class="type">String</span> <span class="variable">resReg</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">            <span class="type">String</span> <span class="variable">left</span> <span class="operator">=</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">right</span> <span class="operator">=</span> lAndExp.getValue();</span><br><span class="line">            writeRes(<span class="keyword">new</span> <span class="title class_">IcmpIR</span>(resReg, left, <span class="string">&quot;ne&quot;</span>, right) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">trueBlock</span> <span class="operator">=</span> <span class="string">&quot;block&quot;</span> + blockId;</span><br><span class="line">            <span class="type">String</span> <span class="variable">falseBlock</span> <span class="operator">=</span> <span class="string">&quot;block&quot;</span> + node.getFalseId();</span><br><span class="line">            regId++;</span><br><span class="line">            writeRes(<span class="keyword">new</span> <span class="title class_">BrIR</span>(resReg, trueBlock, falseBlock) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            writeRes(<span class="string">&quot;\nblock&quot;</span> + blockId+<span class="string">&quot;:\n&quot;</span>);</span><br><span class="line">            blockId++;</span><br><span class="line">            <span class="type">SyntaxWord</span> <span class="variable">eqExp</span> <span class="operator">=</span> children.get(<span class="number">2</span>);</span><br><span class="line">            handle(eqExp);</span><br><span class="line">            node.setValue(eqExp.getValue());</span><br><span class="line">            <span class="comment">// 当前节点是顶级LAnd节点才需输出如下</span></span><br><span class="line">            <span class="keyword">if</span>(node.equals(FatherLAnd))&#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">cond</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">                resReg = cond;</span><br><span class="line">                right = eqExp.getValue();</span><br><span class="line">                trueBlock = <span class="string">&quot;block&quot;</span> + node.getTrueId();</span><br><span class="line">                falseBlock= <span class="string">&quot;block&quot;</span> + node.getFalseId();</span><br><span class="line">                ++regId;</span><br><span class="line">                writeRes(<span class="keyword">new</span> <span class="title class_">IcmpIR</span>(cond, left, <span class="string">&quot;ne&quot;</span>, right) + <span class="string">&quot;\n&quot;</span></span><br><span class="line">                        + <span class="keyword">new</span> <span class="title class_">BrIR</span>(resReg, trueBlock, falseBlock)  + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">LOrExp</span><span class="params">(SyntaxWord node)</span>&#123;</span><br><span class="line">        ArrayList&lt;SyntaxWord&gt; children = node.getChildren();</span><br><span class="line">        String TOPLORright;</span><br><span class="line">        <span class="keyword">if</span>(children.size() == <span class="number">1</span>) &#123;<span class="comment">//单推LANd,传值后处理，进LAnd</span></span><br><span class="line">            <span class="type">SyntaxWord</span> <span class="variable">lAndExp</span> <span class="operator">=</span> children.get(<span class="number">0</span>);</span><br><span class="line">            lAndExp.setTrueId(node.getTrueId());</span><br><span class="line">            lAndExp.setFalseId(node.getFalseId());</span><br><span class="line">            lAndExp.setStmtId(node.getStmtId());</span><br><span class="line">            handle(lAndExp);</span><br><span class="line">            node.setValue(lAndExp.getValue());</span><br><span class="line">            TOPLORright = lAndExp.getValue();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;<span class="comment">// 三节点，递归处理</span></span><br><span class="line">            <span class="comment">// 左杈LOr true 同父级， False开新的给lAnd，</span></span><br><span class="line">            <span class="type">SyntaxWord</span> <span class="variable">lOrExp</span> <span class="operator">=</span> children.get(<span class="number">0</span>);</span><br><span class="line">            <span class="type">SyntaxWord</span> <span class="variable">lAndExp</span> <span class="operator">=</span> children.get(<span class="number">2</span>);</span><br><span class="line">            lOrExp.setTrueId(node.getTrueId());</span><br><span class="line">            lOrExp.setFalseId(blockId++);</span><br><span class="line">            LOrExp(lOrExp);</span><br><span class="line">            <span class="type">String</span> <span class="variable">resReg</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">            <span class="type">String</span> <span class="variable">left</span> <span class="operator">=</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">right</span> <span class="operator">=</span> lOrExp.getValue();</span><br><span class="line">            writeRes(<span class="keyword">new</span> <span class="title class_">IcmpIR</span>(resReg, left, <span class="string">&quot;ne&quot;</span>, right) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">trueBlock</span> <span class="operator">=</span> <span class="string">&quot;block&quot;</span> + node.getTrueId();</span><br><span class="line">            <span class="type">String</span> <span class="variable">falseBlock</span> <span class="operator">=</span> <span class="string">&quot;block&quot;</span> + lOrExp.getFalseId();</span><br><span class="line">            regId++;</span><br><span class="line">            writeRes(<span class="keyword">new</span> <span class="title class_">BrIR</span>(resReg, trueBlock, falseBlock) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            writeRes(<span class="string">&quot;\nblock&quot;</span> + lOrExp.getFalseId()+<span class="string">&quot;:\n&quot;</span>);</span><br><span class="line">            blockId++;</span><br><span class="line">            lAndExp.setFalseId(node.getFalseId());</span><br><span class="line">            handle(lAndExp);</span><br><span class="line">            node.setValue(lAndExp.getValue());</span><br><span class="line">            TOPLORright = lAndExp.getValue();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//当前节点为顶级父节则需为当前CondBlock输出如下：</span></span><br><span class="line">        <span class="keyword">if</span>(node.equals(FatherLOr))&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cond</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">            <span class="type">String</span> <span class="variable">trueBlock</span> <span class="operator">=</span> <span class="string">&quot;block&quot;</span> + node.getTrueId();</span><br><span class="line">            String falseBlock= <span class="string">&quot;block&quot;</span> + node.getFalseId();</span><br><span class="line">            ++regId;</span><br><span class="line">            writeRes(<span class="keyword">new</span> <span class="title class_">IcmpIR</span>(cond, <span class="string">&quot;0&quot;</span>, <span class="string">&quot;ne&quot;</span>, TOPLORright) + <span class="string">&quot;\n&quot;</span></span><br><span class="line">                    + <span class="keyword">new</span> <span class="title class_">BrIR</span>(cond, trueBlock, falseBlock)  + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>LVal处理较为复杂，首先将LVal分为全局与局部，全局的变量可从<code>global</code>表中获取，之后又分为全局变量赋值和全局变量使用，变量类型为普通变量，一维数组与二维数组，局部变量需按对应变量类型(普通变量，一维数组与二维数组)处理。LVal节点子节点数可能为1,4,7，<code>size == 7</code>时最为简单，仅为对二维数组具体元素的使用，当<code>size == 4</code>时可能为一维数组具体元素的使用或二维数组的部分(二维数组的部分传参)使用，当<code>size == 1</code>时，可能为普通变量使用或一维数组传参，或二维数组传参。<br>具体设计如下：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">LVal</span><span class="params">(SyntaxWord node)</span> &#123;</span><br><span class="line">    <span class="comment">//Ident size = 1</span></span><br><span class="line">    <span class="comment">//Ident [Exp] size =  4</span></span><br><span class="line">    <span class="comment">//Ident [Exp][Exp] size = 7</span></span><br><span class="line">    ArrayList&lt;SyntaxWord&gt; children = node.getChildren();</span><br><span class="line">    <span class="type">int</span> <span class="variable">LValType</span> <span class="operator">=</span>children.size();</span><br><span class="line">    <span class="type">SyntaxWord</span> <span class="variable">ident</span> <span class="operator">=</span> children.get(<span class="number">0</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">ident_name</span> <span class="operator">=</span> ident.getToken().getContent();</span><br><span class="line">    <span class="type">SyntaxWord</span> <span class="variable">identSymbol</span> <span class="operator">=</span> querySymbolOnStack(ident_name);<span class="comment">//在栈上查询该变量的符号</span></span><br><span class="line">    <span class="type">Symbol2</span> <span class="variable">sym</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (identSymbol == <span class="literal">null</span>)&#123;<span class="comment">//不在栈上则为全局变量</span></span><br><span class="line">        sym = global.get(ident_name).getSymbol();<span class="comment">//获取全局变量符号</span></span><br><span class="line">        identSymbol = global.get(ident_name);</span><br><span class="line">        <span class="keyword">if</span>(identSymbol == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//e</span></span><br><span class="line">            System.out.println(<span class="string">&quot;no Define&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(floor == <span class="number">0</span>)&#123;<span class="comment">// 全局变量赋值;</span></span><br><span class="line">            <span class="keyword">assert</span> identSymbol != <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">switch</span> (LValType)&#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>-&gt;&#123;<span class="comment">//全局普通变量赋值</span></span><br><span class="line">                    node.setValue(identSymbol.getSymbol().getIntVal());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">4</span>-&gt;&#123;<span class="comment">//全局一维数组赋值</span></span><br><span class="line">                    <span class="type">SyntaxWord</span> <span class="variable">exp</span> <span class="operator">=</span> children.get(<span class="number">2</span>);</span><br><span class="line">                    Exp(exp);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> Integer.parseInt(exp.getValue());</span><br><span class="line">                    node.setValue(identSymbol.getSymbol().getDim1().get(i));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">7</span>-&gt;&#123;<span class="comment">//全局二维数组赋值</span></span><br><span class="line">                    SyntaxWord exp1,exp2;</span><br><span class="line">                    exp1 = children.get(<span class="number">2</span>);</span><br><span class="line">                    exp2 = children.get(<span class="number">5</span>);</span><br><span class="line">                    Exp(exp1);</span><br><span class="line">                    handle(exp2);</span><br><span class="line">                    <span class="type">int</span> x,y;</span><br><span class="line">                    x = Integer.parseInt(exp1.getValue());</span><br><span class="line">                    y = Integer.parseInt(exp2.getValue());</span><br><span class="line">                    node.setValue(identSymbol.getSymbol().getDim2()[x][y]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//块内使用全局变量</span></span><br><span class="line">            <span class="keyword">switch</span> (LValType)&#123;</span><br><span class="line">                <span class="comment">//二维数组元素使用</span></span><br><span class="line">                <span class="keyword">case</span> <span class="number">7</span>-&gt;&#123;</span><br><span class="line">                    SyntaxWord exp1,exp2;</span><br><span class="line">                    exp1 = children.get(<span class="number">2</span>);</span><br><span class="line">                    exp2 = children.get(<span class="number">5</span>);</span><br><span class="line">                    Exp(exp1);</span><br><span class="line">                    handle(exp2);</span><br><span class="line">                    <span class="type">int</span> x,y;</span><br><span class="line">                    x = sym.getX();</span><br><span class="line">                    y = sym.getY();</span><br><span class="line">                    <span class="type">String</span> <span class="variable">address</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">                    regId++;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">srcReg</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">                    regId++;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">geteIR</span> <span class="operator">=</span> tab + address + <span class="string">&quot; = getelementptr [&quot;</span> + x + <span class="string">&quot; x [&quot;</span> + y + <span class="string">&quot; x i32]], [&quot;</span></span><br><span class="line">                            + x + <span class="string">&quot; x [&quot;</span> + y + <span class="string">&quot; x i32]]&quot;</span> + <span class="string">&quot;* @&quot;</span> + ident_name + <span class="string">&quot;, i32 0, i32 &quot;</span> + exp1.getValue()+</span><br><span class="line">                            <span class="string">&quot;, i32 &quot;</span> + exp2.getValue() + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                    writeRes(geteIR);</span><br><span class="line">                    writeRes(<span class="keyword">new</span> <span class="title class_">LoadIR</span>(srcReg, address) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    node.setValue(srcReg);</span><br><span class="line">                    node.setRegId(address);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//一维数组元素使用 或 二维数组部分使用</span></span><br><span class="line">                <span class="keyword">case</span> <span class="number">4</span>-&gt;&#123;</span><br><span class="line">                    <span class="type">SyntaxWord</span> <span class="variable">exp</span> <span class="operator">=</span> children.get(<span class="number">2</span>);</span><br><span class="line">                    Exp(exp);</span><br><span class="line">                    <span class="keyword">if</span>(sym.getDim() == <span class="number">1</span>)&#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span>+regId;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> <span class="string">&quot;@&quot;</span> + ident_name;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> sym.getX();</span><br><span class="line">                        <span class="type">String</span> <span class="variable">tmp</span> <span class="operator">=</span><span class="string">&quot;\t&quot;</span> + res + <span class="string">&quot; = getelementptr [&quot;</span> + len + <span class="string">&quot; x i32],&quot;</span> +</span><br><span class="line">                                <span class="string">&quot; [&quot;</span> + len + <span class="string">&quot; x i32]* &quot;</span> + base + <span class="string">&quot;, i32 0, i32 &quot;</span> + exp.getValue()+ <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                        writeRes(tmp);</span><br><span class="line">                        writeRes(<span class="keyword">new</span> <span class="title class_">LoadIR</span>(<span class="string">&quot;%x&quot;</span>+(regId+<span class="number">1</span>), res)+<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                        sym.setAddr(<span class="string">&quot;i32&quot;</span>);</span><br><span class="line">                        regId++;</span><br><span class="line">                        node.setValue(<span class="string">&quot;%x&quot;</span>+regId);</span><br><span class="line">                        node.setRegId(res);</span><br><span class="line">                        regId++;</span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(sym.getDim() == <span class="number">2</span>)&#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">                        String op1, op2;</span><br><span class="line">                        op1 = exp.getValue();</span><br><span class="line">                        op2 = String.valueOf(sym.getY());</span><br><span class="line">                        regId++;</span><br><span class="line">                        writeRes(<span class="keyword">new</span> <span class="title class_">MultIR</span>(res, op1, op2) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                        <span class="type">int</span> m, n;</span><br><span class="line">                        m = sym.getX();</span><br><span class="line">                        n = sym.getY();</span><br><span class="line">                        writeRes(tab+<span class="string">&quot;%x&quot;</span>+regId+<span class="string">&quot; = getelementptr [&quot;</span>+m+<span class="string">&quot; x [&quot;</span>+n+<span class="string">&quot; x i32]], [&quot;</span>+m+<span class="string">&quot; x [&quot;</span>+n+<span class="string">&quot; x i32]]* @&quot;</span>+ident_name+<span class="string">&quot;, i32 0, i32 0\n&quot;</span>);</span><br><span class="line">                        regId++;</span><br><span class="line">                        writeRes(GepIrDim2(<span class="string">&quot;%x&quot;</span> + regId, String.valueOf(n), <span class="string">&quot;%x&quot;</span> + (regId - <span class="number">1</span>), <span class="string">&quot;%x&quot;</span> + (regId - <span class="number">2</span>) + <span class="string">&quot;\n&quot;</span>));</span><br><span class="line">                        sym.setAddr(<span class="string">&quot;i32*&quot;</span>);</span><br><span class="line">                        node.setValue(<span class="string">&quot;%x&quot;</span> + regId);</span><br><span class="line">                        node.setRegId(<span class="string">&quot;%x&quot;</span> + regId);</span><br><span class="line">                        regId++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//普通变量使用 或 传参一维数组首地址， 或传参二维数组首地址</span></span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>-&gt;&#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">dim</span> <span class="operator">=</span> sym.getDim();</span><br><span class="line">                    <span class="keyword">switch</span> (dim)&#123;</span><br><span class="line">                        <span class="keyword">case</span> <span class="number">0</span>-&gt;&#123;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">address</span> <span class="operator">=</span> <span class="string">&quot;@&quot;</span> + ident_name;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">                            regId++;</span><br><span class="line">                            writeRes(<span class="keyword">new</span> <span class="title class_">LoadIR</span>(res, address) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                            node.setValue(res);</span><br><span class="line">                            node.setRegId(address);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">case</span> <span class="number">1</span>-&gt;&#123;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">address</span> <span class="operator">=</span> <span class="string">&quot;@&quot;</span> + ident_name;</span><br><span class="line">                            <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> sym.getX();</span><br><span class="line">                            sym.setAddr(<span class="string">&quot;i32*&quot;</span>);</span><br><span class="line">                            writeRes(<span class="keyword">new</span> <span class="title class_">GepIR</span>(res, len, address) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                            node.setValue(res);</span><br><span class="line">                            node.setRegId(res);</span><br><span class="line">                            regId++;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">case</span> <span class="number">2</span>-&gt;&#123;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">reg</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">                            <span class="type">int</span> m,n;</span><br><span class="line">                            m = sym.getX();</span><br><span class="line">                            n = sym.getY();</span><br><span class="line">                            sym.setAddr(<span class="string">&quot;[&quot;</span> + n + <span class="string">&quot; x i32]*&quot;</span>);</span><br><span class="line">                            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> tab + reg +<span class="string">&quot; = getelementptr [&quot;</span>+ m +<span class="string">&quot; x [&quot;</span>+ n +<span class="string">&quot; x i32]], [&quot;</span>+ m +<span class="string">&quot; x [&quot;</span>+ n +<span class="string">&quot; x i32]]* &quot;</span>+(<span class="string">&quot;@&quot;</span> + ident_name)+<span class="string">&quot;, i32 0, i32 0\n&quot;</span>;</span><br><span class="line">                            writeRes(s);</span><br><span class="line">                            node.setRegId(reg);</span><br><span class="line">                            node.setValue(reg);</span><br><span class="line">                            regId++;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;<span class="comment">// 在栈式符号表上</span></span><br><span class="line">        sym = identSymbol.getSymbol();<span class="comment">//获取栈上节点的符号</span></span><br><span class="line">        <span class="keyword">switch</span> (LValType)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>-&gt;&#123;</span><br><span class="line">                <span class="comment">//使用栈上普通变量</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">dim</span> <span class="operator">=</span> sym.getDim();<span class="comment">//获取变量维数</span></span><br><span class="line">                <span class="keyword">if</span>(dim == <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="comment">//Ident   普通变量 = 普通变量</span></span><br><span class="line">                    sym.setAddr(<span class="string">&quot;i32&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">resReg</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">address</span> <span class="operator">=</span> identSymbol.getRegId();</span><br><span class="line">                    PropagationLVal(node, resReg, address);<span class="comment">//RegId ++ DIF: RegId += 2;</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(dim == <span class="number">1</span>)&#123;</span><br><span class="line">                    <span class="comment">//使用栈上一维数组首地址</span></span><br><span class="line">                    sym.setAddr(<span class="string">&quot;i32*&quot;</span>);</span><br><span class="line">                    <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    int func(int arr[])&#123;</span></span><br><span class="line"><span class="comment">                        int brr[2] = &#123;1,2&#125;;</span></span><br><span class="line"><span class="comment">                        printf(&quot;%d, arr[1]); //k.getX() == 0</span></span><br><span class="line"><span class="comment">                        printf(&quot;%d, brr[1]); //k.getX() != 0</span></span><br><span class="line"><span class="comment">                    &#125;</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">if</span>(sym.getX() == <span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="comment">//使用定义函数参数中一维数组首地址(传入的一维数组的首地址)</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">reg1</span>  <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">address</span> <span class="operator">=</span> identSymbol.getRegId();</span><br><span class="line">                        <span class="comment">//%x341 = load i32, i32* %x302</span></span><br><span class="line">                        <span class="comment">//%v397 = load i32*, i32* * %v352</span></span><br><span class="line">                        writeRes(tab+ reg1 + <span class="string">&quot; = load i32*, i32* * &quot;</span>+address + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                        node.setValue(reg1);</span><br><span class="line">                        node.setRegId(reg1);</span><br><span class="line">                        regId++;</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="comment">//使用块(父级块)内定义的一维数组的首地址</span></span><br><span class="line">                        <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> sym.getX();</span><br><span class="line">                        <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> identSymbol.getRegId();</span><br><span class="line">                        writeRes(<span class="keyword">new</span> <span class="title class_">GepIR</span>(res, len, base) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                        node.setValue(res);</span><br><span class="line">                        node.setRegId(res);</span><br><span class="line">                        regId++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(dim == <span class="number">2</span>)&#123;</span><br><span class="line">                    <span class="comment">//使用栈上二维数组的首地址</span></span><br><span class="line">                     <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    int func(int arr[]3)&#123;</span></span><br><span class="line"><span class="comment">                        int brr[2][2] = &#123;&#123;1,2&#125;,&#123;1,2&#125;&#125;;</span></span><br><span class="line"><span class="comment">                        printf(&quot;%d, arr[1][0]); //k.getX() == 0</span></span><br><span class="line"><span class="comment">                        printf(&quot;%d, brr[1][0]); //k.getX() != 0</span></span><br><span class="line"><span class="comment">                    &#125;</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">if</span> (sym.getX() == <span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">reg</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">address</span> <span class="operator">=</span> identSymbol.getRegId();</span><br><span class="line">                        <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> sym.getY();</span><br><span class="line">                        sym.setAddr(<span class="string">&quot;[&quot;</span>+y+<span class="string">&quot; x i32]*&quot;</span>);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> tab+reg+<span class="string">&quot; = load [&quot;</span>+ y +<span class="string">&quot; x i32] *, [&quot;</span> + y + <span class="string">&quot; x i32]* * &quot;</span>+address+<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                        writeRes(s);</span><br><span class="line">                        node.setValue(reg);</span><br><span class="line">                        node.setRegId(address);</span><br><span class="line">                        ++regId;</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">nowReg</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">                        <span class="type">int</span> m, n;</span><br><span class="line">                        m = sym.getX();</span><br><span class="line">                        n = sym.getY();</span><br><span class="line">                        <span class="type">String</span> <span class="variable">address</span> <span class="operator">=</span> identSymbol.getRegId();</span><br><span class="line">                        sym.setAddr(<span class="string">&quot;[&quot;</span>+ n +<span class="string">&quot; x i32]*&quot;</span>);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> tab + nowReg + <span class="string">&quot; = getelementptr [&quot;</span> + m + <span class="string">&quot; x [&quot;</span></span><br><span class="line">                                + n +<span class="string">&quot; x i32]], [&quot;</span></span><br><span class="line">                                + m +<span class="string">&quot; x [&quot;</span></span><br><span class="line">                                + n +<span class="string">&quot; x i32]]*&quot;</span></span><br><span class="line">                                + address</span><br><span class="line">                                +<span class="string">&quot;, i32 0, i32 0&quot;</span>;</span><br><span class="line">                        writeRes(output + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                        node.setValue(nowReg);</span><br><span class="line">                        node.setRegId(nowReg);</span><br><span class="line">                        ++regId;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>-&gt;&#123; <span class="comment">//Ident[Exp]</span></span><br><span class="line">                <span class="comment">//一维数组元素使用</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">symbolDim</span> <span class="operator">=</span> identSymbol.getSymbol().getDim();</span><br><span class="line">                <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> sym.getX();</span><br><span class="line">                <span class="type">SyntaxWord</span> <span class="variable">exp</span> <span class="operator">=</span> children.get(<span class="number">2</span>);</span><br><span class="line">                Exp(exp);</span><br><span class="line">                <span class="keyword">switch</span> (symbolDim)&#123;</span><br><span class="line">                    <span class="comment">//使用栈上一维数组的元素</span></span><br><span class="line">                    <span class="keyword">case</span>  <span class="number">1</span>-&gt; &#123;</span><br><span class="line">                        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                        void func(int arr[])&#123;</span></span><br><span class="line"><span class="comment">                            int brr[2] = &#123;1,2&#125;;</span></span><br><span class="line"><span class="comment">                            int if_true = arr[0]; // x == 0;</span></span><br><span class="line"><span class="comment">                            int if_false = brr[0]; // x!= 0;</span></span><br><span class="line"><span class="comment">                        &#125;</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">                        sym.setAddr(<span class="string">&quot;i32&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span>(x == <span class="number">0</span>)&#123;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">reg</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">                            writeRes(tab + reg + <span class="string">&quot; = load i32*, i32* * &quot;</span> + identSymbol.getRegId() + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                            writeRes(tab + <span class="string">&quot;%x&quot;</span> + (regId+<span class="number">1</span>) + <span class="string">&quot; = getelementptr i32, i32* %x&quot;</span>+ regId +<span class="string">&quot;, i32 &quot;</span> + exp.getValue() + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                            regId++;</span><br><span class="line">                            node.setRegId(<span class="string">&quot;%x&quot;</span> + regId);</span><br><span class="line">                            writeRes(tab + <span class="string">&quot;%x&quot;</span> + (<span class="number">1</span> + regId) + <span class="string">&quot; = load i32, i32* %x&quot;</span> + regId + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                            regId++;</span><br><span class="line">                            node.setValue(<span class="string">&quot;%x&quot;</span> +  regId);</span><br><span class="line">                            regId++;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> sym.getX();</span><br><span class="line">                            writeRes(tab + <span class="string">&quot;%x&quot;</span> + regId + <span class="string">&quot; = getelementptr [&quot;</span> + m + <span class="string">&quot; x i32], [&quot;</span> + m + <span class="string">&quot; x i32]*&quot;</span> + identSymbol.getRegId() + <span class="string">&quot;, i32 0, i32 &quot;</span> + exp.getValue() + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                            writeRes(tab + <span class="string">&quot;%x&quot;</span>+(regId+<span class="number">1</span>) + <span class="string">&quot; = load i32, i32* %x&quot;</span> + regId + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                            node.setRegId(<span class="string">&quot;%x&quot;</span>+regId);</span><br><span class="line">                            regId++;</span><br><span class="line">                            node.setValue(<span class="string">&quot;%x&quot;</span>+regId);</span><br><span class="line">                            regId++;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//使用栈上二维数组的某一行首地址</span></span><br><span class="line">                          <span class="comment">/*</span></span><br><span class="line"><span class="comment">                        void func(int arr[][5])&#123;</span></span><br><span class="line"><span class="comment">                            int brr[2][2] = &#123;&#123;1112,2222&#125;,&#123;1111,2222&#125;&#125;;</span></span><br><span class="line"><span class="comment">                            int if_true = arr[0][3]; // x == 0;</span></span><br><span class="line"><span class="comment">                            int if_false = brr[0][0]; // x!= 0;</span></span><br><span class="line"><span class="comment">                        &#125;</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">                    <span class="keyword">case</span> <span class="number">2</span>-&gt; &#123;</span><br><span class="line">                        sym.setAddr(<span class="string">&quot;i32*&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span>(x == <span class="number">0</span>)&#123;</span><br><span class="line">                            <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> sym.getY();</span><br><span class="line">                            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> tab + <span class="string">&quot;%x&quot;</span> + regId + <span class="string">&quot; = load [&quot;</span> + len + <span class="string">&quot; x i32] *, [&quot;</span> + len + <span class="string">&quot; x i32]* * &quot;</span>  + identSymbol.getRegId();</span><br><span class="line">                            writeRes(s + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                            regId++;</span><br><span class="line">                            s = tab + <span class="string">&quot;%x&quot;</span> + regId + <span class="string">&quot; = getelementptr [&quot;</span> + len+<span class="string">&quot; x i32], [&quot;</span> + len + <span class="string">&quot; x i32]* %x&quot;</span> + (regId - <span class="number">1</span>) + <span class="string">&quot;, i32 &quot;</span> + exp.getValue();</span><br><span class="line">                            writeRes(s + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                            regId++;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">reg</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + (regId - <span class="number">1</span>);</span><br><span class="line">                            writeRes(<span class="keyword">new</span> <span class="title class_">GepIR</span>(reg, len, base) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                            node.setValue(reg);</span><br><span class="line">                            node.setRegId(reg);</span><br><span class="line">                        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="type">int</span> m, n;</span><br><span class="line">                            String output;</span><br><span class="line">                            m = sym.getX();</span><br><span class="line">                            n = sym.getY();</span><br><span class="line">                            <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">op1</span> <span class="operator">=</span> exp.getValue();</span><br><span class="line">                            <span class="type">String</span> <span class="variable">op2</span> <span class="operator">=</span> String.valueOf(sym.getY());</span><br><span class="line">                            writeRes(<span class="keyword">new</span> <span class="title class_">MultIR</span>(res, op1, op2) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                            regId++;</span><br><span class="line">                            output = tab + <span class="string">&quot;%x&quot;</span> + regId + <span class="string">&quot; = getelementptr [&quot;</span> + m + <span class="string">&quot; x [&quot;</span> + n + <span class="string">&quot; x i32]], [&quot;</span> + m + <span class="string">&quot; x [&quot;</span> + n + <span class="string">&quot; x i32]]*&quot;</span> + identSymbol.getRegId() + <span class="string">&quot;, i32 0, i32 0&quot;</span>;</span><br><span class="line">                            writeRes(output + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                            regId++;</span><br><span class="line">                            output = tab + <span class="string">&quot;%x&quot;</span> + regId + <span class="string">&quot; = getelementptr [&quot;</span> + n + <span class="string">&quot; x i32], [&quot;</span> + n + <span class="string">&quot; x i32]* %x&quot;</span> + (regId - <span class="number">1</span>) + <span class="string">&quot;, i32 0, i32 %x&quot;</span> + (regId - <span class="number">2</span>) ;</span><br><span class="line">                            writeRes(output + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                            node.setValue(<span class="string">&quot;%x&quot;</span> + (regId));</span><br><span class="line">                            node.setRegId(<span class="string">&quot;%x&quot;</span> + (regId));</span><br><span class="line">                        &#125;</span><br><span class="line">                        regId++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">7</span>-&gt;&#123;</span><br><span class="line">                <span class="comment">//二维数组元素使用</span></span><br><span class="line">                SyntaxWord exp1,exp2;</span><br><span class="line">                exp1 = children.get(<span class="number">2</span>);</span><br><span class="line">                exp2 = children.get(<span class="number">5</span>);</span><br><span class="line">                Exp(exp1);</span><br><span class="line">                Exp(exp2);</span><br><span class="line">                <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> sym.getX();</span><br><span class="line">                <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> sym.getY();</span><br><span class="line">                <span class="comment">// 使用参数中定义的二维数组元素，定义时不规定二维数组行数</span></span><br><span class="line">                <span class="keyword">if</span>(sym.getX() == <span class="number">0</span>)&#123;</span><br><span class="line">                    sym.setAddr(<span class="string">&quot;i32&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> tab + <span class="string">&quot;%x&quot;</span> + regId + <span class="string">&quot; = load [&quot;</span>+ n +<span class="string">&quot; x i32] *, [&quot;</span> + n + <span class="string">&quot; x i32]* * &quot;</span> + identSymbol.getRegId();</span><br><span class="line">                    writeRes(s + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    regId++;</span><br><span class="line">                    s = tab + <span class="string">&quot;%x&quot;</span>+ regId + <span class="string">&quot; = getelementptr [&quot;</span> + n + <span class="string">&quot; x i32], [&quot;</span> + n + <span class="string">&quot; x i32]* &quot;</span> + <span class="string">&quot;%x&quot;</span> + (regId - <span class="number">1</span>) + <span class="string">&quot;, i32 &quot;</span> + exp1.getValue();</span><br><span class="line">                    writeRes(s + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    regId++;</span><br><span class="line">                    s = tab + <span class="string">&quot;%x&quot;</span> + regId + <span class="string">&quot; = getelementptr [&quot;</span> + n + <span class="string">&quot; x i32], [&quot;</span> + n +<span class="string">&quot; x i32]* %x&quot;</span> + (regId - <span class="number">1</span>) + <span class="string">&quot;, i32 0, i32 &quot;</span> + exp2.getValue();</span><br><span class="line">                    writeRes(s + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    writeRes(<span class="keyword">new</span> <span class="title class_">LoadIR</span>(<span class="string">&quot;%x&quot;</span> + (<span class="number">1</span> + regId), <span class="string">&quot;%x&quot;</span> + regId) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    node.setRegId(<span class="string">&quot;%x&quot;</span>+ regId);</span><br><span class="line">                    regId++;</span><br><span class="line">                    node.setValue(<span class="string">&quot;%x&quot;</span>+ regId);</span><br><span class="line">                    regId++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 使用(父)块内定义的二维数组元素</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">loadAddress</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span>  + regId;</span><br><span class="line">                    regId++;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">loadReg</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">                    writeRes(tab+loadAddress</span><br><span class="line">                            + <span class="string">&quot; = getelementptr [&quot;</span></span><br><span class="line">                            + m +<span class="string">&quot; x [&quot;</span></span><br><span class="line">                            + n +<span class="string">&quot; x i32]], [&quot;</span></span><br><span class="line">                            + m +<span class="string">&quot; x [&quot;</span></span><br><span class="line">                            + n +<span class="string">&quot; x i32]]*&quot;</span></span><br><span class="line">                            + identSymbol.getRegId()</span><br><span class="line">                            + <span class="string">&quot;, i32 0, i32 &quot;</span></span><br><span class="line">                            + exp1.getValue()</span><br><span class="line">                            + <span class="string">&quot;, i32 &quot;</span></span><br><span class="line">                            + exp2.getValue()</span><br><span class="line">                            + <span class="string">&quot;\n&quot;</span></span><br><span class="line">                    );</span><br><span class="line">                    writeRes(<span class="keyword">new</span> <span class="title class_">LoadIR</span>(loadReg, loadAddress) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    node.setValue(loadReg);</span><br><span class="line">                    node.setRegId(loadAddress);</span><br><span class="line">                    sym.setAddr(<span class="string">&quot;i32&quot;</span>);</span><br><span class="line">                    regId++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    node.setSymbol(sym);<span class="comment">//设置当前节点Symbol</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="编码后修改-4">编码后修改</h2><blockquote><p>基本同编码前设计，仅针对UnaryExp的遗漏情况进行修改，以及Parse模块添加语句减少代码生成工作量。</p><ul><li>实际测试中发现UnaryExp与UnaryOp也存在递归情况，设计对UnaryExp的抽象语法树自底向上进行运算，先递归访问到最右端的UnaryExp，计算其初值，之后自底向上，遇到&quot;+“则直接向上传值,”-&quot;则新增sub语句，用0减去当前值实现取负后在向上传值</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">UnaryExp</span><span class="params">(SyntaxWord node)</span> &#123;</span><br><span class="line">    ArrayList&lt;SyntaxWord&gt; children = node.getChildren();</span><br><span class="line">    <span class="comment">// UnaryExp → PrimaryExp | Ident &#x27;(&#x27; [FuncRParams] &#x27;)&#x27;| UnaryOp UnaryExp</span></span><br><span class="line">    <span class="keyword">if</span>(!children.get(<span class="number">0</span>).isEnd() &amp;&amp; children.get(<span class="number">0</span>).getType().equals(<span class="string">&quot;PrimaryExp&quot;</span>))&#123;</span><br><span class="line">        <span class="type">SyntaxWord</span> <span class="variable">primaryExp</span> <span class="operator">=</span> children.get(<span class="number">0</span>);</span><br><span class="line">        handle(primaryExp);</span><br><span class="line">        node.setValue(primaryExp.getValue());</span><br><span class="line">        node.setRegId(primaryExp.getRegId());</span><br><span class="line">        node.setSymbol(primaryExp.getSymbol());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!children.get(<span class="number">0</span>).isEnd() &amp;&amp; children.get(<span class="number">0</span>).getType().equals(<span class="string">&quot;UnaryOp&quot;</span>)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">unaryOp</span> <span class="operator">=</span> children.get(<span class="number">0</span>).getChild0Content();</span><br><span class="line">        <span class="type">SyntaxWord</span> <span class="variable">unaryExp</span> <span class="operator">=</span> children.get(<span class="number">1</span>);</span><br><span class="line">        handle(unaryExp);</span><br><span class="line">        <span class="keyword">switch</span> (unaryOp)&#123;</span><br><span class="line">            <span class="keyword">case</span><span class="string">&quot;+&quot;</span>-&gt; node.setValue(unaryExp.getValue());</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;-&quot;</span>-&gt;&#123;</span><br><span class="line">                <span class="keyword">if</span>(floor == <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">preValue</span> <span class="operator">=</span> Integer.parseInt(unaryExp.getValue());</span><br><span class="line">                    preValue = -preValue;</span><br><span class="line">                    node.setValue(String.valueOf(preValue));</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;<span class="comment">//添加Sub 0 语句</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">left</span> <span class="operator">=</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">right</span> <span class="operator">=</span> unaryExp.getValue();</span><br><span class="line">                    writeRes(calIR(left, <span class="string">&quot;-&quot;</span>, right) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">reg</span> <span class="operator">=</span> <span class="string">&quot;%x&quot;</span> + regId;</span><br><span class="line">                    node.setRegId(reg);</span><br><span class="line">                    node.setValue(reg);</span><br><span class="line">                    ++regId;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ···</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>为减少代码冗余，减轻代码生成阶段工作量，在SynTaxWord类中新添一维数组<code>forElements</code>及字符串’StmtType’，在Parse模块<code>Stmt</code>函数中将for语句的元素存在情况存于forElemets中，判断Stmt类型后将其类型储存在StmtType中以便LlvmGeneratror模块中直接使用switch分类处理。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SyntaxWord</span> &#123;</span><br><span class="line">   ···</span><br><span class="line">   <span class="type">int</span>[] forElemets = <span class="literal">null</span>;</span><br><span class="line">   <span class="comment">//size = 3的一维数组以1,0标记该for语句是否有ForStmt,Cond和forStmt</span></span><br><span class="line">   <span class="comment">//如for(i = 1;;); 其forElements为&#123;1,0,0&#125;</span></span><br><span class="line">   ···    </span><br><span class="line"></span><br><span class="line">&gt;&#125;</span><br><span class="line">&gt;<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">Stmt</span><span class="params">(SyntaxWord node)</span> &#123;</span><br><span class="line">       ArrayList&lt;SyntaxWord&gt; children  = node.getChildren();</span><br><span class="line">       <span class="type">String</span> <span class="variable">stmtType</span> <span class="operator">=</span> node.getStmtType();</span><br><span class="line">       <span class="keyword">switch</span> (stmtType)&#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;Assignment&quot;</span>-&gt;&#123;</span><br><span class="line">               ···</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;Block&quot;</span> -&gt;&#123;</span><br><span class="line">             ···</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;Exp&quot;</span> -&gt;&#123;</span><br><span class="line">               ···</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;Return&quot;</span>-&gt;&#123;</span><br><span class="line">               ···</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;Input&quot;</span>-&gt;&#123;</span><br><span class="line">               ···</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;Output&quot;</span>-&gt;&#123;</span><br><span class="line">               ···</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;If&quot;</span>-&gt;&#123;</span><br><span class="line">               ···</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;Break&quot;</span>-&gt;&#123;</span><br><span class="line">               ···</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;Continue&quot;</span>-&gt;&#123;</span><br><span class="line">               ···</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">case</span> <span class="string">&quot;Loop&quot;</span>-&gt;&#123;</span><br><span class="line">               ···</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span>(node.getStmtId() == -<span class="number">1</span>)&#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       writeRes(tab + <span class="string">&quot;br label %block&quot;</span> + node.getStmtId() + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></blockquote></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/">编译原理</a><a class="post-meta__tags" href="/tags/Java/">Java</a></div><div class="post_share"><div class="social-share" data-image="/img/Ada.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/17f8a560.html" title="alt + 数字打出对应希腊字母"><div class="cover" style="background:var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">alt + 数字打出对应希腊字母</div></div></a></div><div class="next-post pull-right"><a href="/post/9bba8236.html" title="文法定义"><div class="cover" style="background:var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">文法定义</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/9bba8236.html" title="文法定义"><div class="cover" style="background:var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-07</div><div class="title">文法定义</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/Ada.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">58Q83</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/58Q83"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">1.编译器简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">(1) 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">1.2.</span> <span class="toc-text">(2) 错误处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%94%9F%E6%88%90%E7%BB%93%E6%9E%9C%E5%B1%95%E7%A4%BA"><span class="toc-number">1.3.</span> <span class="toc-text">(3) 生成结果展示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E4%BB%A3%E7%A0%81"><span class="toc-number">1.3.1.</span> <span class="toc-text">输入代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%87%BA"><span class="toc-number">1.3.2.</span> <span class="toc-text">输出</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">2.编译器的总体设计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%80%BB%E4%BD%93%E7%BB%93%E6%9E%84"><span class="toc-number">2.1.</span> <span class="toc-text">(1) 总体结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1"><span class="toc-number">2.2.</span> <span class="toc-text">(2) 接口设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%96%87%E4%BB%B6%E7%BB%84%E7%BB%87"><span class="toc-number">2.3.</span> <span class="toc-text">(3) 文件组织</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">3.词法分析设计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%89%8D%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.1.</span> <span class="toc-text">编码前设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%90%8E%E4%BF%AE%E6%94%B9"><span class="toc-number">3.2.</span> <span class="toc-text">编码后修改</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">4.语法分析设计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%89%8D%E8%AE%BE%E8%AE%A1-2"><span class="toc-number">4.1.</span> <span class="toc-text">编码前设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%90%8E%E4%BF%AE%E6%94%B9-2"><span class="toc-number">4.2.</span> <span class="toc-text">编码后修改</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%B7%A6%E9%80%92%E5%BD%92%E6%96%87%E6%B3%95"><span class="toc-number">4.2.1.</span> <span class="toc-text">1.左递归文法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Stmt%E5%A4%84%E7%90%86"><span class="toc-number">4.2.2.</span> <span class="toc-text">2.Stmt处理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">5.错误处理设计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%89%8D%E8%AE%BE%E8%AE%A1-3"><span class="toc-number">5.1.</span> <span class="toc-text">编码前设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%90%8E%E4%BF%AE%E6%94%B9-3"><span class="toc-number">5.2.</span> <span class="toc-text">编码后修改</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%AC%A6%E5%8F%B7%E8%A1%A8%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.2.1.</span> <span class="toc-text">1.符号表实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#for%E5%BE%AA%E7%8E%AF%E8%AF%AD%E5%8F%A5%E5%A4%84%E7%90%86"><span class="toc-number">5.2.2.</span> <span class="toc-text">for循环语句处理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">6.</span> <span class="toc-text">6.代码生成设计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%89%8D%E8%AE%BE%E8%AE%A1-4"><span class="toc-number">6.1.</span> <span class="toc-text">编码前设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%90%8E%E4%BF%AE%E6%94%B9-4"><span class="toc-number">6.2.</span> <span class="toc-text">编码后修改</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/post/424f083.html" title="Vue使用高德API实现地图组件">Vue使用高德API实现地图组件</a><time datetime="2025-06-05T13:32:42.000Z" title="发表于 2025-06-05 21:32:42">2025-06-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/post/c2789e9d.html" title="Python添加(修改)MP3音乐封面">Python添加(修改)MP3音乐封面</a><time datetime="2024-09-11T03:08:01.000Z" title="发表于 2024-09-11 11:08:01">2024-09-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/post/f06da149.html" title="live2d-widget + live2d_api 向Hexo博客部署live2d看板娘">live2d-widget + live2d_api 向Hexo博客部署live2d看板娘</a><time datetime="2024-08-28T03:16:35.000Z" title="发表于 2024-08-28 11:16:35">2024-08-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/post/17f8a560.html" title="alt + 数字打出对应希腊字母">alt + 数字打出对应希腊字母</a><time datetime="2024-08-15T03:49:02.000Z" title="发表于 2024-08-15 11:49:02">2024-08-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/post/38d18c3f.html" title="SysY to LLVM简易编译器文档">SysY to LLVM简易编译器文档</a><time datetime="2024-07-07T14:26:30.000Z" title="发表于 2024-07-07 22:26:30">2024-07-07</time></div></div></div></div></div></div></main><footer id="footer" style="background:rgb(226,213,133,0)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By 58Q83</div><img src="https://s21.ax1x.com/2024/09/04/pAVxBdA.png" style="vertical-align:middle" height="20px"> <a href="https://icp.gov.moe/?keyword=20245249" target="_blank">萌ICP备20245249号</a><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script id="canvas_nest" defer color="173,222,252" opacity="0.8" zindex="-1" count="60" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors=["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",function(){if(window.tocScrollFn&&window.removeEventListener("scroll",window.tocScrollFn),window.scrollCollect&&window.removeEventListener("scroll",scrollCollect),document.getElementById("rightside").style.cssText="opacity: ''; transform: ''",window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();var e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode"),"object"==typeof disqusjs&&disqusjs.destroy()}),document.addEventListener("pjax:complete",function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{let t=document.createElement("script");var o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll()}),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script data-pjax src="https://registry.npmmirror.com/oh-my-live2d/0.19.3/files/dist/index.min.js"></script><script>let oml2d=OML2D.loadOml2d({dockedPosition:"left",mobileDisplay:!1,models:[{path:"/live2d_models/shinobu/live2D.model3.json",scale:.12,position:[10,120],volume:0,stageStyle:{height:270,width:300}}],parentElement:document.body,primaryColor:"var(--btn-bg)",sayHello:!1,tips:{style:{width:230,height:120,left:"calc(50% - 20px)",top:"-50px"},mobileStyle:{width:180,height:80,left:"calc(50% - 30px)",top:"-100px"},idleTips:{interval:6e4,message:function(){return Math.random()<.5?axios.get("https://v1.hitokoto.cn?c=i").then(function(t){return t.data.hitokoto}).catch(function(t){console.error(t)}):Promise.resolve("咔咔~")}}}})</script></body></html>